<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#e0e5ec" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="B-SIDE">
  <title>B-SIDE</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* === RESET & VARIABLES === */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #e0e5ec;
      --bg-dark: #d1d9e6;
      --text: #1a1a1a;
      --text-secondary: #5a6170;
      --accent: #1a1a1a;
      --shadow-light: #ffffff;
      --shadow-dark: #a3b1c6;
      --neu-flat: -1px -1px 2px var(--shadow-light), 1px 1px 2px var(--shadow-dark);
      --neu-pressed: inset -1px -1px 2px var(--shadow-light), inset 1px 1px 2px var(--shadow-dark);
      --neu-convex: -1px -1px 3px var(--shadow-light), 1px 1px 3px var(--shadow-dark);
    }
    
    [data-theme="dark"] {
      --bg: #2d3436;
      --bg-dark: #232526;
      --text: #ffffff;
      --text-secondary: #a0a0a0;
      --accent: #ffffff;
      --shadow-light: #3d4447;
      --shadow-dark: #1d2425;
    }
    
    /* === BASE === */
    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .app {
      height: 100%;
      max-width: 430px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-bottom: 0;
    }
    
    /* === DEBUG CONSOLE === */
    .debug-console {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 180px;
      background: rgba(0, 0, 0, 0.95);
      color: #0f0;
      font-family: monospace;
      font-size: 10px;
      padding: 5px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
    }
    .debug-console.show { display: block; }
    .debug-line { margin: 1px 0; }
    .debug-line.error { color: #f55; }
    .debug-line.warn { color: #fa0; }
    .debug-line.success { color: #5f5; }
    .debug-line.network { color: #5ff; }
    .debug-toggle {
      position: fixed;
      top: 5px;
      right: 5px;
      width: 30px;
      height: 30px;
      background: #333;
      color: #0f0;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      z-index: 10000;
      cursor: pointer;
    }
    .debug-console.show ~ .debug-toggle { top: 185px; }
    
    /* === TOP BAR === */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 5px;
      margin-bottom: 20px;
    }
    
    .icon-btn {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 12px;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .icon-btn:active { box-shadow: var(--neu-pressed); }
    .icon-btn svg { width: 20px; height: 20px; }
    
    /* === DATE PICKER === */
    .date-picker-btn {
      background: var(--bg);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      box-shadow: var(--neu-flat);
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }
    .date-picker-btn:active { box-shadow: var(--neu-pressed); }
    .date-picker-btn span { font-size: 0.9rem; font-weight: 600; color: var(--text); }
    .date-picker-btn svg { color: var(--text-secondary); width: 18px; height: 18px; }
    .date-picker-btn input {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    /* === ARTWORK === */
    .artwork-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    .artwork {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      background: var(--bg);
      box-shadow: var(--neu-convex);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .artwork h1 { font-size: 3.2rem; font-weight: 800; letter-spacing: -2px; color: var(--text); margin-bottom: 8px; }
    .artwork p { font-size: 1rem; font-weight: 400; color: var(--text-secondary); }
    
    /* === TRACK INFO === */
    .track-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 10px;
    }
    .track-details h2 { font-size: 1.4rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .track-details p { font-size: 0.9rem; color: var(--text-secondary); }
    
    /* === FAVORITE BUTTON === */
    .fav-btn {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .fav-btn:active { box-shadow: var(--neu-pressed); }
    .fav-btn.active { color: #e74c3c; }
    .fav-btn.active svg { fill: #e74c3c; }
    .fav-btn svg { width: 22px; height: 22px; }
    
    /* === PROGRESS BAR === */
    .progress-section { padding: 10px 10px 20px; }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      box-shadow: var(--neu-pressed);
      position: relative;
      cursor: pointer;
      touch-action: none;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
    }
    .progress-thumb {
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: var(--bg);
      border-radius: 50%;
      box-shadow: var(--neu-flat);
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }
    
    /* === BUFFER INDICATOR === */
    .buffer-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--text-secondary);
      opacity: 0.3;
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s;
    }
    
    /* === STATUS MESSAGE === */
    .status-message {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .status-message.show { opacity: 1; }
    .status-message.error { color: #e74c3c; }
    .status-message.warning { color: #f39c12; }
    .status-message.success { color: #27ae60; }
    .status-message .network-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--bg-dark);
      border-radius: 4px;
      opacity: 0.8;
    }
    .status-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* === CONTROLS === */
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 15px 0 25px;
    }
    .ctrl-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 14px;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .ctrl-btn:active { box-shadow: var(--neu-pressed); }
    .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ctrl-btn svg { width: 18px; height: 18px; }
    .play-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: -2px -2px 5px var(--shadow-light), 2px 2px 5px var(--shadow-dark);
      color: var(--bg);
    }
    .play-btn:active { box-shadow: -1px -1px 3px var(--shadow-light), 1px 1px 3px var(--shadow-dark); }
    .play-btn svg { width: 28px; height: 28px; fill: var(--bg); }

    /* === BOTTOM NAV === */
    .bottom-nav {
      background: var(--bg);
      border-radius: 24px 24px 0 0;
      box-shadow: -2px -2px 5px var(--shadow-light), 2px 2px 5px var(--shadow-dark);
      padding: 15px 30px 25px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 0 -20px;
    }
    .nav-item {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 14px;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      font-weight: 600;
      gap: 2px;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-item.active {
      background: var(--bg);
      box-shadow: var(--neu-pressed);
      color: var(--accent);
    }
    .nav-item svg { width: 22px; height: 22px; }
    .sleep-countdown { font-size: 0.75rem; font-weight: 700; color: var(--accent); }
    
    /* === NETWORK INDICATOR === */
    .network-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 1000;
      transition: all 0.3s;
    }
    .network-indicator.show { display: flex; }
    .network-indicator.offline { background: #e74c3c; color: white; }
    .network-indicator.slow { background: #f39c12; color: white; }
    .network-indicator.online { background: #27ae60; color: white; }
    
    /* === POPUPS === */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.3);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .popup-overlay.show { display: flex; }
    
    .volume-popup {
      background: var(--bg);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--neu-flat);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .volume-slider {
      width: 8px;
      height: 150px;
      background: var(--bg);
      border-radius: 4px;
      box-shadow: var(--neu-pressed);
      position: relative;
      cursor: pointer;
      touch-action: none;
    }
    .volume-fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: var(--accent);
      border-radius: 4px;
    }
    .volume-fill .progress-thumb { top: -8px; right: 50%; transform: translateX(50%); }
    .popup-title { font-size: 0.9rem; font-weight: 600; color: var(--text); }
    
    .sleep-menu {
      background: var(--bg);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--neu-flat);
    }
    .sleep-option {
      padding: 15px 40px;
      border-radius: 12px;
      background: var(--bg);
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text);
      box-shadow: var(--neu-flat);
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
    }
    .sleep-option:last-child { margin-bottom: 0; }
    .sleep-option:active { box-shadow: var(--neu-pressed); }
    .sleep-option.selected { color: var(--accent); box-shadow: var(--neu-pressed); }
    
    .favorites-popup {
      background: var(--bg);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--neu-flat);
      max-width: 300px;
      width: 90%;
    }
    .favorites-header { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 15px; text-align: center; }
    .favorites-list { max-height: 250px; overflow-y: auto; }
    .fav-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .fav-item:active { box-shadow: var(--neu-pressed); }
    .fav-item-del { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; }
    .fav-item-del:hover { color: #e74c3c; }
    .fav-item-del svg { width: 16px; height: 16px; }
    .favorites-empty { text-align: center; color: var(--text-secondary); font-size: 0.9rem; padding: 20px; }
    
    /* === INSTALL PROMPT === */
    .install-prompt {
      display: none;
      position: fixed;
      bottom: 100px;
      left: 20px; right: 20px;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      box-shadow: var(--neu-flat);
      z-index: 1000;
    }
    .install-prompt.show { display: block; }
    .install-prompt p { margin-bottom: 16px; font-size: 0.95rem; font-weight: 500; }
    .install-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
    }
    .install-close {
      background: var(--bg);
      color: var(--text-secondary);
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: var(--neu-flat);
    }
    
    audio { display: none; }
  </style>
</head>

<body>
  <!-- DEBUG CONSOLE -->
  <div class="debug-console" id="debugConsole"></div>
  <button class="debug-toggle" id="debugToggle">ðŸ”§</button>
  
  <!-- NETWORK INDICATOR -->
  <div class="network-indicator" id="networkIndicator">
    <span id="networkIcon">ðŸ“¶</span>
    <span id="networkText">Online</span>
  </div>

  <div class="app">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="date-picker-btn" id="datePickerBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span id="dateDisplay">--/--/----</span>
        <input type="date" id="datePicker">
      </div>
      <button class="icon-btn" id="menuBtn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="5" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="12" cy="19" r="2"/>
        </svg>
      </button>
    </div>

    <!-- ARTWORK -->
    <div class="artwork-container">
      <div class="artwork">
        <h1>B-SIDE</h1>
        <p>Alessio Bertallot</p>
      </div>
    </div>

    <!-- TRACK INFO -->
    <div class="track-info">
      <div class="track-details">
        <h2 id="episodeDate">--/--/----</h2>
        <p>Radio Capital</p>
      </div>
      <button class="fav-btn" id="favBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </button>
    </div>

    <!-- PROGRESS SECTION -->
    <div class="progress-section">
      <div class="progress-bar" id="progressBar">
        <div class="buffer-bar" id="bufferBar"></div>
        <div class="progress-fill" id="progressFill">
          <div class="progress-thumb"></div>
        </div>
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="remainingTime">-0:00</span>
      </div>
      <div class="status-message" id="statusMessage">
        <span id="statusText"></span>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <button class="ctrl-btn" id="prevDay">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
        </svg>
      </button>
      <button class="ctrl-btn" id="skipBack">-30</button>
      <button class="ctrl-btn play-btn" id="playBtn">
        <svg viewBox="0 0 24 24" id="playIcon">
          <polygon points="6,4 20,12 6,20"/>
        </svg>
      </button>
      <button class="ctrl-btn" id="skipForward">+30</button>
      <button class="ctrl-btn" id="nextDay">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 6h2v12h-2zM6 18l8.5-6L6 6z"/>
        </svg>
      </button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
      <button class="nav-item" id="sleepBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="sleepIcon">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span class="sleep-countdown" id="sleepCountdown" style="display:none;"></span>
      </button>
      <button class="nav-item active" id="volumeNavBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="volumeIcon">
          <path d="M11 5L6 9H2v6h4l5 4V5z"/>
          <path d="M15.54 8.46a5 5 0 010 7.07"/>
          <path d="M19.07 4.93a10 10 0 010 14.14"/>
        </svg>
      </button>
      <button class="nav-item" id="themeBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- POPUP OVERLAYS -->
  <div class="popup-overlay" id="volumeOverlay">
    <div class="volume-popup">
      <span class="popup-title">Volume</span>
      <div class="volume-slider" id="volumeSlider">
        <div class="volume-fill" id="volumeFill" style="height:100%;">
          <div class="progress-thumb"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="sleepOverlay">
    <div class="sleep-menu">
      <div class="sleep-option" data-min="15">15 min</div>
      <div class="sleep-option" data-min="30">30 min</div>
      <div class="sleep-option" data-min="60">60 min</div>
      <div class="sleep-option" data-min="90">90 min</div>
      <div class="sleep-option" data-min="0">Off</div>
    </div>
  </div>

  <div class="popup-overlay" id="favOverlay">
    <div class="favorites-popup">
      <div class="favorites-header">Preferiti</div>
      <div class="favorites-list" id="favList"></div>
    </div>
  </div>

  <div class="install-prompt" id="installPrompt">
    <p>Installa B-SIDE sulla tua home screen</p>
    <button class="install-btn" id="installBtn">Installa</button>
    <button class="install-close" id="installClose">No grazie</button>
  </div>
  
  <audio id="audio" preload="auto"></audio>
  <!-- BLOCCO 3: Inserisci subito dopo </audio> del blocco 2 -->

  <script>
// ============================================
// DEBUG SYSTEM
// ============================================
var DEBUG_ENABLED = true;
var debugConsole = document.getElementById('debugConsole');
var debugToggle = document.getElementById('debugToggle');
var debugLogs = [];
var MAX_LOGS = 150;

debugToggle.onclick = function() { debugConsole.classList.toggle('show'); };

function log(msg, type) {
  if (!DEBUG_ENABLED) return;
  type = type || 'info';
  var t = new Date();
  var ts = t.toLocaleTimeString('it-IT') + '.' + String(t.getMilliseconds()).padStart(3, '0');
  var line = '[' + ts + '] ' + msg;
  debugLogs.push({ t: line, y: type });
  if (debugLogs.length > MAX_LOGS) debugLogs.shift();
  var h = '';
  for (var i = 0; i < debugLogs.length; i++) {
    h += '<div class="debug-line ' + debugLogs[i].y + '">' + debugLogs[i].t + '</div>';
  }
  debugConsole.innerHTML = h;
  debugConsole.scrollTop = debugConsole.scrollHeight;
  console.log('[' + type.toUpperCase() + ']', msg);
}

// ============================================
// STREAMING ENGINE - STATO CENTRALIZZATO
// ============================================
var Engine = {
  // Audio element
  audio: null,
  currentUrl: '',
  
  // Position tracking
  position: {
    current: 0,
    lastSaved: 0,
    saveInterval: null
  },
  
  // Buffer health
  buffer: {
    ahead: 0,
    minHealthy: 10,
    isHealthy: false,
    percent: 0
  },
  
  // Network state
  network: {
    isOnline: navigator.onLine,
    type: null,
    downlink: null,
    rtt: null,
    saveData: false,
    quality: 100
  },
  
  // Recovery system
  recovery: {
    isActive: false,
    startTime: null,
    attempt: 0,
    maxAttempts: 50,
    strategy: 'seek',
    timer: null,
    watchdog: null,
    watchdogTimeout: 12000
  },
  
  // User intent
  intent: {
    shouldBePlaying: false,
    pausedByUser: false,
    pausedBySystem: false
  },
  
  // App lifecycle
  lifecycle: {
    isVisible: true,
    isActive: true,
    wakeLock: null,
    lastActiveTime: Date.now()
  }
};

// ============================================
// DOM ELEMENTS
// ============================================
var audio = document.getElementById('audio');
var datePicker = document.getElementById('datePicker');
var datePickerBtn = document.getElementById('datePickerBtn');
var dateDisplay = document.getElementById('dateDisplay');
var episodeDate = document.getElementById('episodeDate');
var progressBar = document.getElementById('progressBar');
var progressFill = document.getElementById('progressFill');
var bufferBar = document.getElementById('bufferBar');
var currentTimeEl = document.getElementById('currentTime');
var remainingTime = document.getElementById('remainingTime');
var playBtn = document.getElementById('playBtn');
var playIcon = document.getElementById('playIcon');
var prevDay = document.getElementById('prevDay');
var nextDay = document.getElementById('nextDay');
var skipBack = document.getElementById('skipBack');
var skipForward = document.getElementById('skipForward');
var favBtn = document.getElementById('favBtn');
var sleepBtn = document.getElementById('sleepBtn');
var sleepIcon = document.getElementById('sleepIcon');
var sleepCountdown = document.getElementById('sleepCountdown');
var volumeNavBtn = document.getElementById('volumeNavBtn');
var volumeIcon = document.getElementById('volumeIcon');
var themeBtn = document.getElementById('themeBtn');
var themeIcon = document.getElementById('themeIcon');
var volumeOverlay = document.getElementById('volumeOverlay');
var volumeSlider = document.getElementById('volumeSlider');
var volumeFill = document.getElementById('volumeFill');
var sleepOverlay = document.getElementById('sleepOverlay');
var favOverlay = document.getElementById('favOverlay');
var favList = document.getElementById('favList');
var menuBtn = document.getElementById('menuBtn');
var statusMessage = document.getElementById('statusMessage');
var statusText = document.getElementById('statusText');
var themeColorMeta = document.getElementById('themeColor');
var networkIndicator = document.getElementById('networkIndicator');
var networkIcon = document.getElementById('networkIcon');
var networkText = document.getElementById('networkText');

// State
var isPlaying = false;
var sleepTimer = null;
var sleepEndTime = null;
var sleepInterval = null;
var favorites = JSON.parse(localStorage.getItem('bside-fav') || '[]');
var deferredPrompt = null;
var progressDragging = false;
var seekTime = 0;
var volDrag = false;

// Initialize engine reference
Engine.audio = audio;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatTime(s) {
  if (isNaN(s) || s < 0) return '0:00';
  var m = Math.floor(s / 60);
  var sec = Math.floor(s % 60);
  return m + ':' + (sec < 10 ? '0' : '') + sec;
}

function formatDate(d) {
  var p = d.split('-');
  return p[2] + '/' + p[1] + '/' + p[0];
}

function buildUrl(d) {
  var p = d.split('-');
  return 'https://media.capital.it/' + p[0] + '/' + p[1] + '/' + p[2] + '/episodes/bertallot/bertallot_' + p[0] + p[1] + p[2] + '_220000.mp3';
}

function updatePlayIcon(playing) {
  playIcon.innerHTML = playing 
  ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' 
  : '<polygon points="6,4 20,12 6,20"/>';
}

// ============================================
// STATUS & UI
// ============================================
function showStatus(msg, type, spin) {
  var html = '';
  if (spin) html += '<span class="status-spinner"></span> ';
  html += msg;
  
  // Add network badge if relevant
  if ((type === 'warning' || type === 'error') && Engine.network.type) {
    html += ' <span class="network-badge">' + Engine.network.type.toUpperCase() + '</span>';
  }
  
  statusText.innerHTML = html;
  statusMessage.className = 'status-message show ' + (type || '');
}

function hideStatus() {
  statusMessage.classList.remove('show');
}

function showNetworkIndicator(type, text) {
  networkIndicator.className = 'network-indicator show ' + type;
  networkText.textContent = text;
  networkIcon.textContent = type === 'offline' ? 'ðŸ“µ' : (type === 'slow' ? 'ðŸ“¶' : 'âœ“');
  
  // Auto-hide success after 2s
  if (type === 'online') {
    setTimeout(function() {
      networkIndicator.classList.remove('show');
    }, 2000);
  }
}

function hideNetworkIndicator() {
  networkIndicator.classList.remove('show');
}

// ============================================
// NETWORK MONITORING
// ============================================
function initNetworkMonitoring() {
  updateNetworkInfo();
  
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  
  // Network Information API
  if ('connection' in navigator) {
    var conn = navigator.connection;
    conn.addEventListener('change', function() {
      var oldType = Engine.network.type;
      var oldQuality = Engine.network.quality;
      updateNetworkInfo();
      var newType = Engine.network.type;
      var newQuality = Engine.network.quality;
      
      log('Network change: ' + oldType + ' â†’ ' + newType + ' (quality: ' + oldQuality + ' â†’ ' + newQuality + ')', 'network');
      
      // If network improved and we should be playing, retry immediately
      if (Engine.intent.shouldBePlaying && newQuality > oldQuality) {
        log('Network improved, INSTANT recovery', 'network');
        Engine.recovery.attempt = 0;
        clearRecoveryTimers();
        if (!isPlaying) {
          executeRecovery();
        }
      }
    });
  }
}

function updateNetworkInfo() {
  var conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  
  Engine.network.isOnline = navigator.onLine;
  
  if (conn) {
    Engine.network.type = conn.effectiveType;
    Engine.network.downlink = conn.downlink;
    Engine.network.rtt = conn.rtt;
    Engine.network.saveData = conn.saveData;
  }
  
  Engine.network.quality = calculateNetworkQuality();
}

function calculateNetworkQuality() {
  if (!navigator.onLine) return 0;
  
  var type = Engine.network.type;
  var downlink = Engine.network.downlink;
  var rtt = Engine.network.rtt;
  
  // Base quality from connection type
  var quality = 100;
  if (type === 'slow-2g') quality = 10;
  else if (type === '2g') quality = 30;
  else if (type === '3g') quality = 60;
  else if (type === '4g') quality = 90;
  
  // Adjust for actual bandwidth
  if (downlink !== null && downlink !== undefined) {
    if (downlink < 0.5) quality = Math.min(quality, 20);
    else if (downlink < 1) quality = Math.min(quality, 40);
    else if (downlink < 2) quality = Math.min(quality, 60);
  }
  
  // Adjust for latency
  if (rtt !== null && rtt !== undefined) {
    if (rtt > 500) quality = Math.min(quality, 30);
    else if (rtt > 300) quality = Math.min(quality, 50);
  }
  
  return quality;
}

function handleOnline() {
  log('NETWORK: online', 'success');
  Engine.network.isOnline = true;
  updateNetworkInfo();
  showNetworkIndicator('online', 'Connesso');
  
  if (Engine.intent.shouldBePlaying && !isPlaying) {
    log('Online + shouldBePlaying: INSTANT recovery', 'network');
    Engine.recovery.attempt = 0;
    clearRecoveryTimers();
    // Instant retry - no delay
    executeRecovery();
  }
}

function handleOffline() {
  log('NETWORK: offline', 'error');
  Engine.network.isOnline = false;
  Engine.network.quality = 0;
  
  showNetworkIndicator('offline', 'Offline');
  
  if (isPlaying || Engine.intent.shouldBePlaying) {
    Engine.intent.shouldBePlaying = true;
    Engine.position.current = audio.currentTime || Engine.position.current;
    savePositionToStorage();
    log('Saved position for offline: ' + formatTime(Engine.position.current), 'warn');
  }
  
  showStatus('Offline - in attesa di connessione...', 'error');
}

// ============================================
// BUFFER MONITORING
// ============================================
function updateBufferHealth() {
  var buffered = audio.buffered;
  var currentTime = audio.currentTime;
  var duration = audio.duration;
  
  // Calculate seconds buffered ahead
  var ahead = 0;
  for (var i = 0; i < buffered.length; i++) {
    if (buffered.start(i) <= currentTime && buffered.end(i) > currentTime) {
      ahead = buffered.end(i) - currentTime;
      break;
    }
  }
  
  Engine.buffer.ahead = ahead;
  
  // Adaptive threshold based on network
  var minHealthy = getAdaptiveBufferThreshold();
  Engine.buffer.minHealthy = minHealthy;
  Engine.buffer.isHealthy = ahead >= minHealthy;
  
  // Update buffer bar UI
  if (duration > 0) {
    var bufferEnd = 0;
    for (var j = 0; j < buffered.length; j++) {
      if (buffered.end(j) > bufferEnd) {
        bufferEnd = buffered.end(j);
      }
    }
    Engine.buffer.percent = (bufferEnd / duration) * 100;
    bufferBar.style.width = Engine.buffer.percent + '%';
  }
}

function getAdaptiveBufferThreshold() {
  var quality = Engine.network.quality;
  if (quality < 30) return 20;  // Bad network: want 20s buffer
  if (quality < 60) return 15;  // Medium: 15s
  return 10;                     // Good: 10s
}

// ============================================
// POSITION TRACKING
// ============================================
function initPositionTracking() {
  // Save to localStorage every 15 seconds
  Engine.position.saveInterval = setInterval(function() {
    if (Engine.position.current > 0 && Math.abs(Engine.position.current - Engine.position.lastSaved) > 5) {
      savePositionToStorage();
    }
  }, 15000);
  
  // Save on exit
  window.addEventListener('beforeunload', savePositionToStorage);
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'hidden') {
      savePositionToStorage();
    }
  });
}

function savePositionToStorage() {
  if (Engine.position.current <= 0) return;
  
  var key = 'bside-pos-' + datePicker.value;
  var data = {
    position: Engine.position.current,
    duration: audio.duration || 0,
    timestamp: Date.now()
  };
  
  try {
    localStorage.setItem(key, JSON.stringify(data));
    Engine.position.lastSaved = Engine.position.current;
    log('Position saved: ' + formatTime(data.position));
  } catch (e) {
    log('Failed to save position: ' + e.message, 'error');
  }
}

function loadPositionFromStorage() {
  var key = 'bside-pos-' + datePicker.value;
  
  try {
    var saved = localStorage.getItem(key);
    if (saved) {
      var data = JSON.parse(saved);
      // Check if not too old (7 days)
      var age = Date.now() - data.timestamp;
      if (age < 7 * 24 * 60 * 60 * 1000) {
        Engine.position.current = data.position;
        Engine.position.lastSaved = data.position;
        log('Position restored: ' + formatTime(data.position), 'success');
        return data.position;
      }
    }
  } catch (e) {
    log('Failed to load position: ' + e.message, 'error');
  }
  return 0;
}

// ============================================
// RECOVERY SYSTEM
// ============================================
function clearRecoveryTimers() {
  if (Engine.recovery.timer) {
    clearTimeout(Engine.recovery.timer);
    Engine.recovery.timer = null;
  }
  if (Engine.recovery.watchdog) {
    clearTimeout(Engine.recovery.watchdog);
    Engine.recovery.watchdog = null;
  }
}

function setRecoveryWatchdog() {
  clearTimeout(Engine.recovery.watchdog);
  var timeout = Engine.recovery.strategy === 'refetch' ? 15000 : Engine.recovery.watchdogTimeout;
  
  Engine.recovery.watchdog = setTimeout(function() {
    if (Engine.recovery.isActive) {
      log('WATCHDOG: timeout triggered, forcing restart', 'error');
      Engine.recovery.isActive = false;
      startRecovery();
    }
  }, timeout);
}

function startRecovery() {
  // Skip if user paused
  if (Engine.intent.pausedByUser) {
    log('Recovery skipped: user paused');
    return;
  }
  
  // Skip if not supposed to be playing
  if (!Engine.intent.shouldBePlaying) {
    log('Recovery skipped: not supposed to be playing');
    return;
  }
  
  // Avoid concurrent recovery
  if (Engine.recovery.isActive && Engine.recovery.startTime) {
    var elapsed = Date.now() - Engine.recovery.startTime;
    if (elapsed < 2000) {
      log('Recovery already in progress (' + elapsed + 'ms), skipping');
      return;
    }
  }
  
  // Check max attempts
  if (Engine.recovery.attempt >= Engine.recovery.maxAttempts) {
    log('Max recovery attempts reached (' + Engine.recovery.maxAttempts + ')', 'error');
    showStatus('Connessione persa. Tocca Play per riprovare.', 'error');
    Engine.intent.shouldBePlaying = false;
    Engine.recovery.isActive = false;
    clearRecoveryTimers();
    return;
  }
  
  // Start recovery
  Engine.recovery.isActive = true;
  Engine.recovery.startTime = Date.now();
  Engine.recovery.attempt++;
  
  // Calculate adaptive delay
  var delay = calculateRecoveryDelay();
  
  log('Recovery #' + Engine.recovery.attempt + ' in ' + delay + 'ms, pos=' + formatTime(Engine.position.current) + ', strategy=' + Engine.recovery.strategy, 'warn');
  showStatus('Riconnessione (' + Engine.recovery.attempt + ')...', 'warning', true);
  
  clearRecoveryTimers();
  setRecoveryWatchdog();
  
  Engine.recovery.timer = setTimeout(executeRecovery, delay);
}

function calculateRecoveryDelay() {
  var attempt = Engine.recovery.attempt;
  var quality = Engine.network.quality;
  var baseDelay;
  
  if (attempt <= 3) {
    // First 3: ultra aggressive
    baseDelay = 100 + (100 * attempt); // 200ms, 300ms, 400ms
  } else if (attempt <= 10) {
    // 4-10: aggressive backoff
    baseDelay = 500 * Math.pow(1.3, attempt - 3); // ~650ms, 845ms, 1.1s...
  } else {
    // 10+: moderate slowdown
    baseDelay = 3000 + (attempt - 10) * 500; // 3.5s, 4s, 4.5s...
  }
  
  // Adjust for network quality
  if (quality === 0) {
    baseDelay = Math.max(baseDelay, 2000);
  } else if (quality < 30) {
    baseDelay *= 1.3;
  }
  
  return Math.min(baseDelay, 8000);
}

function selectRecoveryStrategy() {
  var attempt = Engine.recovery.attempt;
  
  if (attempt <= 1 && audio.readyState >= 2) {
    Engine.recovery.strategy = 'seek';
  } else if (attempt <= 4) {
    Engine.recovery.strategy = 'reload';
  } else {
    Engine.recovery.strategy = 'refetch';
  }
}

function executeRecovery() {
  // Check if still offline
  if (!navigator.onLine) {
    log('Still offline, rescheduling in 3s', 'warn');
    showStatus('Offline, attendo connessione...', 'error');
    Engine.recovery.timer = setTimeout(startRecovery, 3000);
    return;
  }
  
  selectRecoveryStrategy();
  log('Executing recovery strategy: ' + Engine.recovery.strategy);
  
  switch (Engine.recovery.strategy) {
    case 'seek':
    executeSeekStrategy();
    break;
    case 'reload':
    executeReloadStrategy();
    break;
    case 'refetch':
    executeRefetchStrategy();
    break;
  }
}

function executeSeekStrategy() {
  var targetTime = Engine.position.current;
  
  try {
    if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) {
      audio.currentTime = targetTime;
    }
    attemptPlay();
  } catch (e) {
    log('Seek strategy failed: ' + e.message, 'error');
    Engine.recovery.strategy = 'reload';
    setTimeout(executeRecovery, 500);
  }
}

function executeReloadStrategy() {
  var targetTime = Engine.position.current;
  
  audio.pause();
  audio.load();
  
  var loadTimeout = setTimeout(onLoadError, 15000);
  
  function onCanPlay() {
    clearTimeout(loadTimeout);
    audio.removeEventListener('canplay', onCanPlay);
    audio.removeEventListener('error', onLoadError);
    
    if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) {
      audio.currentTime = targetTime;
      log('Position restored: ' + formatTime(targetTime));
    }
    attemptPlay();
  }
  
  function onLoadError() {
    clearTimeout(loadTimeout);
    audio.removeEventListener('canplay', onCanPlay);
    audio.removeEventListener('error', onLoadError);
    log('Reload strategy failed', 'error');
    setTimeout(startRecovery, 1000);
  }
  
  audio.addEventListener('canplay', onCanPlay);
  audio.addEventListener('error', onLoadError);
}

function executeRefetchStrategy() {
  var targetTime = Engine.position.current;
  
  audio.pause();
  var bustUrl = Engine.currentUrl + (Engine.currentUrl.includes('?') ? '&' : '?') + '_t=' + Date.now();
  audio.src = bustUrl;
  
  var loadTimeout = setTimeout(onLoadError, 20000);
  
  function onCanPlay() {
    clearTimeout(loadTimeout);
    audio.removeEventListener('canplay', onCanPlay);
    audio.removeEventListener('error', onLoadError);
    
    if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) {
      audio.currentTime = targetTime;
      log('Position restored after refetch: ' + formatTime(targetTime));
    }
    attemptPlay();
  }
  
  function onLoadError() {
    clearTimeout(loadTimeout);
    audio.removeEventListener('canplay', onCanPlay);
    audio.removeEventListener('error', onLoadError);
    log('Refetch strategy failed', 'error');
    setTimeout(startRecovery, 1000);
  }
  
  audio.addEventListener('canplay', onCanPlay);
  audio.addEventListener('error', onLoadError);
  audio.load();
}

function attemptPlay() {
  var playPromise = audio.play();
  
  if (playPromise) {
    playPromise.then(function() {
      log('Playback resumed successfully', 'success');
      onRecoverySuccess();
    }).catch(function(err) {
      if (err.name === 'NotAllowedError') {
        log('Autoplay blocked, waiting for user', 'warn');
        showStatus('Tocca Play per riprendere', 'warning');
        Engine.recovery.isActive = false;
        Engine.intent.pausedBySystem = true;
        clearRecoveryTimers();
      } else if (err.name !== 'AbortError') {
        log('Play failed: ' + err.message, 'error');
        setTimeout(startRecovery, 1000);
      }
    });
  }
}

function onRecoverySuccess() {
  Engine.recovery.isActive = false;
  Engine.recovery.attempt = 0;
  Engine.recovery.startTime = null;
  Engine.recovery.strategy = 'seek';
  Engine.intent.pausedBySystem = false;
  
  clearRecoveryTimers();
  hideStatus();
  hideNetworkIndicator();
  acquireWakeLock();
}
</script>
<script>
// ============================================
// WAKE LOCK
// ============================================
async function acquireWakeLock() {
  if (!('wakeLock' in navigator)) return false;
  if (!Engine.lifecycle.isVisible) return false;
  if (Engine.lifecycle.wakeLock) return true;
  
  try {
    Engine.lifecycle.wakeLock = await navigator.wakeLock.request('screen');
    log('Wake lock acquired', 'success');
    
    Engine.lifecycle.wakeLock.addEventListener('release', function() {
      log('Wake lock released');
      Engine.lifecycle.wakeLock = null;
      if (Engine.intent.shouldBePlaying && Engine.lifecycle.isVisible) {
        setTimeout(acquireWakeLock, 1000);
      }
    });
    return true;
  } catch (e) {
    log('Wake lock failed: ' + e.message, 'warn');
    return false;
  }
}

function releaseWakeLock() {
  if (Engine.lifecycle.wakeLock) {
    Engine.lifecycle.wakeLock.release();
    Engine.lifecycle.wakeLock = null;
  }
}

// ============================================
// LIFECYCLE MANAGEMENT
// ============================================
function initLifecycleManagement() {
  document.addEventListener('visibilitychange', function() {
    Engine.lifecycle.isVisible = document.visibilityState === 'visible';
    log('Visibility: ' + (Engine.lifecycle.isVisible ? 'visible' : 'hidden'));
    
    if (Engine.lifecycle.isVisible) {
      onAppVisible();
    } else {
      onAppHidden();
    }
  });
  
  window.addEventListener('focus', function() {
    Engine.lifecycle.isActive = true;
    Engine.lifecycle.lastActiveTime = Date.now();
    onAppVisible();
  });
  
  window.addEventListener('blur', function() {
    Engine.lifecycle.isActive = false;
  });
  
  window.addEventListener('pageshow', function() {
    log('Page show event');
    onAppVisible();
  });
  
  // iOS audio interruption handling
  audio.addEventListener('pause', function() {
    if (!Engine.intent.pausedByUser && Engine.intent.shouldBePlaying) {
      log('Unexpected pause detected (possible interruption)');
      Engine.intent.pausedBySystem = true;
    }
  });
}

function onAppVisible() {
  log('App became visible');
  updateNetworkInfo();
  
  if (Engine.intent.shouldBePlaying) {
    acquireWakeLock();
  }
  
  // Check if we need to recover
  var shouldBePlaying = Engine.intent.shouldBePlaying;
  var isPaused = audio.paused;
  var isRecovering = Engine.recovery.isActive;
  
  if (shouldBePlaying && isPaused && !isRecovering) {
    var hiddenTime = Date.now() - Engine.lifecycle.lastActiveTime;
    log('Was hidden for ' + Math.round(hiddenTime / 1000) + 's, should be playing but paused');
    
    if (hiddenTime > 30000) {
      Engine.recovery.attempt = 0;
    }
    
    startRecovery();
  }
  
  // Sync position
  if (audio.currentTime > 0 && Math.abs(audio.currentTime - Engine.position.current) > 2) {
    log('Position drift: audio=' + formatTime(audio.currentTime) + ', saved=' + formatTime(Engine.position.current));
    Engine.position.current = audio.currentTime;
  }
}

function onAppHidden() {
  log('App became hidden');
  savePositionToStorage();
  Engine.lifecycle.lastActiveTime = Date.now();
}

// ============================================
// AUDIO EVENTS
// ============================================
function initAudioEvents() {
  audio.addEventListener('loadstart', function() {
    log('EVENT: loadstart');
  });
  
  audio.addEventListener('loadedmetadata', function() {
    log('EVENT: loadedmetadata, duration=' + formatTime(audio.duration));
    remainingTime.textContent = '-' + formatTime(audio.duration);
  });
  
  audio.addEventListener('canplay', function() {
    log('EVENT: canplay, readyState=' + audio.readyState, 'success');
  });
  
  audio.addEventListener('stalled', function() {
    log('EVENT: stalled', 'error');
    if (Engine.intent.shouldBePlaying) {
      showStatus('Connessione lenta...', 'warning', true);
      setTimeout(function() {
        if (audio.paused || audio.readyState < 3) {
          startRecovery();
        }
      }, 2000);
    }
  });
  
  audio.addEventListener('pause', function() {
    log('EVENT: pause');
    isPlaying = false;
    updatePlayIcon(false);
    
    if (!Engine.recovery.isActive && !Engine.intent.pausedByUser) {
      releaseWakeLock();
    }
  });
  
  audio.addEventListener('ended', function() {
    log('EVENT: ended');
    isPlaying = false;
    Engine.intent.shouldBePlaying = false;
    Engine.position.current = 0;
    updatePlayIcon(false);
    releaseWakeLock();
    clearRecoveryTimers();
  });
  
  audio.addEventListener('waiting', function() {
    log('EVENT: waiting (buffering)', 'warn');
    if (Engine.intent.shouldBePlaying) {
      var bufferStatus = Engine.buffer.ahead.toFixed(1);
      showStatus('Buffering... (' + bufferStatus + 's)', 'warning', true);
      
      // Pre-recovery after 3s of waiting
      setTimeout(function() {
        if (Engine.intent.shouldBePlaying && (audio.paused || audio.readyState < 3)) {
          log('Waiting too long, starting pre-recovery', 'warn');
          startRecovery();
        }
      }, 3000);
    }
  });
  
  audio.addEventListener('stalled', function() {
    log('EVENT: stalled', 'error');
    if (Engine.intent.shouldBePlaying) {
      showStatus('Connessione lenta...', 'warning', true);
      setTimeout(function() {
        if (audio.paused || audio.readyState < 3) {
          startRecovery();
        }
      }, 5000);
    }
  });
  
  audio.addEventListener('progress', function() {
    updateBufferHealth();
  });
  
  audio.addEventListener('timeupdate', function() {
    if (progressDragging) return;
    
    // Always track position
    if (!audio.paused && audio.currentTime > 0) {
      Engine.position.current = audio.currentTime;
    }
    
    updateBufferHealth();
    
    var pct = (audio.currentTime / audio.duration) * 100 || 0;
    progressFill.style.width = pct + '%';
    currentTimeEl.textContent = formatTime(audio.currentTime);
    remainingTime.textContent = '-' + formatTime(audio.duration - audio.currentTime);
    
    // Media Session position
    if ('mediaSession' in navigator && audio.duration) {
      navigator.mediaSession.setPositionState({
        duration: audio.duration,
        playbackRate: audio.playbackRate,
        position: audio.currentTime
      });
    }
  });
  
  audio.addEventListener('error', function() {
    var err = audio.error;
    var codes = ['', 'ABORTED', 'NETWORK', 'DECODE', 'SRC_NOT_SUPPORTED'];
    var errName = err ? codes[err.code] || 'UNKNOWN' : 'NO_ERROR';
    
    log('EVENT: error - ' + errName, 'error');
    
    // Save position immediately
    if (Engine.position.current > 0) {
      savePositionToStorage();
    }
    
    isPlaying = false;
    updatePlayIcon(false);
    
    // Handle by error type
    if (err && err.code === 4) { // SRC_NOT_SUPPORTED
      if (Engine.recovery.isActive || !navigator.onLine) {
        log('SRC_NOT_SUPPORTED during recovery/offline, continuing...', 'warn');
        if (Engine.intent.shouldBePlaying) {
          startRecovery();
        }
      } else {
        showStatus('Puntata non disponibile', 'error');
        Engine.intent.shouldBePlaying = false;
      }
    } else if (Engine.intent.shouldBePlaying) {
      startRecovery();
    }
  });
}

// ============================================
// PLAY BUTTON
// ============================================
playBtn.addEventListener('click', function() {
  if (isPlaying) {
    // STOP
    log('USER: STOP');
    Engine.intent.shouldBePlaying = false;
    Engine.intent.pausedByUser = true;
    Engine.recovery.isActive = false;
    Engine.position.current = audio.currentTime;
    clearRecoveryTimers();
    audio.pause();
    hideStatus();
    savePositionToStorage();
  } else {
    // PLAY
    log('USER: PLAY, savedPos=' + formatTime(Engine.position.current));
    
    Engine.intent.shouldBePlaying = true;
    Engine.intent.pausedByUser = false;
    Engine.intent.pausedBySystem = false;
    Engine.recovery.isActive = false;
    Engine.recovery.attempt = 0;
    clearRecoveryTimers();
    
    var targetTime = Engine.position.current;
    showStatus('Avvio...', 'warning', true);
    
    if (!audio.src || audio.error || audio.readyState === 0) {
      // Need to load
      log('Loading audio source...');
      var url = buildUrl(datePicker.value);
      Engine.currentUrl = url;
      audio.src = url;
      
      function onReady() {
        audio.removeEventListener('canplay', onReady);
        audio.removeEventListener('error', onLoadErr);
        
        if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) {
          audio.currentTime = targetTime;
          log('Restored position: ' + formatTime(targetTime));
        }
        
        audio.play().catch(function(e) {
          log('Play after load failed: ' + e.message, 'error');
          showStatus('Errore. Riprova.', 'error');
          Engine.intent.shouldBePlaying = false;
        });
      }
      
      function onLoadErr() {
        audio.removeEventListener('canplay', onReady);
        audio.removeEventListener('error', onLoadErr);
        log('Load error', 'error');
        showStatus('Errore caricamento', 'error');
        Engine.intent.shouldBePlaying = false;
      }
      
      audio.addEventListener('canplay', onReady);
      audio.addEventListener('error', onLoadErr);
      audio.load();
    } else {
      // Already loaded
      if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) {
        audio.currentTime = targetTime;
      }
      
      audio.play().catch(function(e) {
        log('Play failed: ' + e.message, 'error');
        if (e.name === 'NotAllowedError') {
          showStatus('Tocca di nuovo Play', 'warning');
          Engine.intent.shouldBePlaying = false;
        } else {
          // Try reload
          var url = buildUrl(datePicker.value);
          Engine.currentUrl = url;
          audio.src = url + '?_t=' + Date.now();
          
          audio.addEventListener('canplay', function onR() {
            audio.removeEventListener('canplay', onR);
            if (targetTime > 0 && audio.duration) {
              audio.currentTime = targetTime;
            }
            audio.play();
          });
          audio.load();
        }
      });
    }
  }
});

// ============================================
// DATE PICKER & NAVIGATION
// ============================================
var today = new Date();
datePicker.value = today.toISOString().split('T')[0];
datePicker.max = datePicker.value;

datePickerBtn.addEventListener('click', function() {
  datePicker.showPicker();
});

datePicker.addEventListener('change', function() {
  updatePlayer();
  updateNav();
  updateFav();
  updateMediaSession();
});

function updatePlayer() {
  var d = datePicker.value;
  var url = buildUrl(d);
  
  log('updatePlayer: ' + d);
  
  clearRecoveryTimers();
  Engine.currentUrl = url;
  Engine.position.current = loadPositionFromStorage();
  Engine.position.lastSaved = Engine.position.current;
  Engine.recovery.attempt = 0;
  Engine.recovery.isActive = false;
  Engine.intent.shouldBePlaying = false;
  
  audio.src = url;
  episodeDate.textContent = formatDate(d);
  dateDisplay.textContent = formatDate(d);
  isPlaying = false;
  updatePlayIcon(false);
  progressFill.style.width = '0%';
  bufferBar.style.width = '0%';
  currentTimeEl.textContent = formatTime(Engine.position.current);
  remainingTime.textContent = '-0:00';
  hideStatus();
}

function updateNav() {
  var curr = new Date(datePicker.value);
  var tod = new Date();
  curr.setHours(0, 0, 0, 0);
  tod.setHours(0, 0, 0, 0);
  nextDay.disabled = curr >= tod;
}

function changeDay(delta) {
  var d = new Date(datePicker.value);
  d.setDate(d.getDate() + delta);
  var str = d.toISOString().split('T')[0];
  
  if (str <= datePicker.max) {
    datePicker.value = str;
    updatePlayer();
    updateNav();
    updateFav();
    updateMediaSession();
  }
}

prevDay.addEventListener('click', function() { changeDay(-1); });
nextDay.addEventListener('click', function() { changeDay(1); });

// ============================================
// SKIP BUTTONS
// ============================================
skipBack.addEventListener('click', function() {
  var t = Math.max(0, audio.currentTime - 30);
  Engine.position.current = t;
  audio.currentTime = t;
  log('Skip back: ' + formatTime(t));
});

skipForward.addEventListener('click', function() {
  var t = audio.currentTime + 30;
  Engine.position.current = t;
  audio.currentTime = t;
  log('Skip forward: ' + formatTime(t));
});

// ============================================
// PROGRESS BAR
// ============================================
function getProgressPct(e) {
  var r = progressBar.getBoundingClientRect();
  var x = e.touches ? e.touches[0].clientX : e.clientX;
  return Math.max(0, Math.min(1, (x - r.left) / r.width));
}

function updateProgressUI(pct) {
  progressFill.style.width = (pct * 100) + '%';
  if (audio.duration) {
    seekTime = pct * audio.duration;
    currentTimeEl.textContent = formatTime(seekTime);
    remainingTime.textContent = '-' + formatTime(audio.duration - seekTime);
  }
}

progressBar.addEventListener('mousedown', function(e) {
  progressDragging = true;
  updateProgressUI(getProgressPct(e));
});

progressBar.addEventListener('touchstart', function(e) {
  e.preventDefault();
  progressDragging = true;
  updateProgressUI(getProgressPct(e));
}, {passive: false});

document.addEventListener('mousemove', function(e) {
  if (progressDragging) updateProgressUI(getProgressPct(e));
});

document.addEventListener('touchmove', function(e) {
  if (progressDragging) updateProgressUI(getProgressPct(e));
}, {passive: true});

document.addEventListener('mouseup', function() {
  if (progressDragging && audio.duration) {
    Engine.position.current = seekTime;
    audio.currentTime = seekTime;
    log('Seek to: ' + formatTime(seekTime));
  }
  progressDragging = false;
});

document.addEventListener('touchend', function() {
  if (progressDragging && audio.duration) {
    Engine.position.current = seekTime;
    audio.currentTime = seekTime;
    log('Seek to: ' + formatTime(seekTime));
  }
  progressDragging = false;
});

  // ============================================
// THEME
// ============================================
var savedTheme = localStorage.getItem('bside-theme') || 'light';
applyTheme(savedTheme);

function applyTheme(t) {
  if (t === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
    themeColorMeta.content = '#2d3436';
  } else {
    document.documentElement.removeAttribute('data-theme');
    themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
    themeColorMeta.content = '#e0e5ec';
  }
}

themeBtn.addEventListener('click', function() {
  var isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  var newTheme = isDark ? 'light' : 'dark';
  applyTheme(newTheme);
  localStorage.setItem('bside-theme', newTheme);
});

// ============================================
// VOLUME
// ============================================
volumeNavBtn.addEventListener('click', function() {
  volumeOverlay.classList.add('show');
});

volumeOverlay.addEventListener('click', function(e) {
  if (e.target === volumeOverlay) {
    volumeOverlay.classList.remove('show');
  }
});

function updateVol(e) {
  var r = volumeSlider.getBoundingClientRect();
  var y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top;
  var pct = 1 - (y / r.height);
  audio.volume = Math.max(0, Math.min(1, pct));
  volumeFill.style.height = (audio.volume * 100) + '%';
  updateVolIcon();
}

function updateVolIcon() {
  var v = audio.volume;
  if (v === 0) {
    volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>';
  } else if (v < 0.5) {
    volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/>';
  } else {
    volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/>';
  }
}

volumeSlider.addEventListener('mousedown', function(e) { volDrag = true; updateVol(e); });
volumeSlider.addEventListener('touchstart', function(e) { e.preventDefault(); volDrag = true; updateVol(e); });
document.addEventListener('mousemove', function(e) { if (volDrag) updateVol(e); });
document.addEventListener('touchmove', function(e) { if (volDrag) { e.preventDefault(); updateVol(e); } }, {passive: false});
document.addEventListener('mouseup', function() { volDrag = false; });
document.addEventListener('touchend', function() { volDrag = false; });

// ============================================
// SLEEP TIMER
// ============================================
sleepBtn.addEventListener('click', function() {
  sleepOverlay.classList.add('show');
});

sleepOverlay.addEventListener('click', function(e) {
  if (e.target === sleepOverlay) {
    sleepOverlay.classList.remove('show');
  }
});

var sleepOptions = document.querySelectorAll('.sleep-option');
sleepOptions.forEach(function(opt) {
  opt.addEventListener('click', function() {
    var min = parseInt(opt.getAttribute('data-min'));
    setSleep(min);
    sleepOverlay.classList.remove('show');
    sleepOptions.forEach(function(o) { o.classList.remove('selected'); });
    if (min > 0) opt.classList.add('selected');
  });
});

function setSleep(min) {
  if (sleepTimer) clearTimeout(sleepTimer);
  if (sleepInterval) clearInterval(sleepInterval);
  
  if (min === 0) {
    sleepEndTime = null;
    sleepIcon.style.display = '';
    sleepCountdown.style.display = 'none';
    sleepBtn.classList.remove('active');
    return;
  }
  
  sleepEndTime = Date.now() + min * 60000;
  sleepBtn.classList.add('active');
  sleepIcon.style.display = 'none';
  sleepCountdown.style.display = '';
  updateSleepDisplay();
  
  sleepInterval = setInterval(updateSleepDisplay, 1000);
  
  sleepTimer = setTimeout(function() {
    Engine.intent.shouldBePlaying = false;
    audio.pause();
    updatePlayIcon(false);
    isPlaying = false;
    setSleep(0);
    log('Sleep timer triggered - playback stopped');
  }, min * 60000);
}

function updateSleepDisplay() {
  if (!sleepEndTime) return;
  var rem = Math.max(0, sleepEndTime - Date.now());
  if (rem === 0) { setSleep(0); return; }
  var m = Math.floor(rem / 60000);
  var s = Math.floor((rem % 60000) / 1000);
  sleepCountdown.textContent = m + ':' + (s < 10 ? '0' : '') + s;
}

// ============================================
// FAVORITES
// ============================================
favBtn.addEventListener('click', function() {
  var d = datePicker.value;
  var idx = favorites.indexOf(d);
  
  if (idx > -1) {
    favorites.splice(idx, 1);
  } else {
    favorites.unshift(d);
  }
  
  localStorage.setItem('bside-fav', JSON.stringify(favorites));
  updateFav();
});

function updateFav() {
  favBtn.classList.toggle('active', favorites.indexOf(datePicker.value) > -1);
}

menuBtn.addEventListener('click', function() {
  renderFavList();
  favOverlay.classList.add('show');
});

favOverlay.addEventListener('click', function(e) {
  if (e.target === favOverlay) {
    favOverlay.classList.remove('show');
  }
});

function renderFavList() {
  if (favorites.length === 0) {
    favList.innerHTML = '<div class="favorites-empty">Nessun preferito</div>';
    return;
  }
  
  var h = '';
  for (var i = 0; i < favorites.length; i++) {
    var d = favorites[i];
    h += '<div class="fav-item" data-date="' + d + '">' +
    '<span>' + formatDate(d) + '</span>' +
    '<button class="fav-item-del" data-date="' + d + '">' +
    '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">' +
    '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>' +
    '</svg></button></div>';
  }
  favList.innerHTML = h;
  
  favList.querySelectorAll('.fav-item').forEach(function(item) {
    item.addEventListener('click', function(e) {
      if (!e.target.closest('.fav-item-del')) {
        datePicker.value = item.getAttribute('data-date');
        updatePlayer();
        updateNav();
        updateFav();
        updateMediaSession();
        favOverlay.classList.remove('show');
      }
    });
  });
  
  favList.querySelectorAll('.fav-item-del').forEach(function(btn) {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      var d = btn.getAttribute('data-date');
      var idx = favorites.indexOf(d);
      if (idx > -1) favorites.splice(idx, 1);
      localStorage.setItem('bside-fav', JSON.stringify(favorites));
      updateFav();
      renderFavList();
    });
  });
}

// ============================================
// MEDIA SESSION API
// ============================================
function updateMediaSession() {
  if ('mediaSession' in navigator) {
    navigator.mediaSession.metadata = new MediaMetadata({
      title: 'Puntata del ' + formatDate(datePicker.value),
      artist: 'Alessio Bertallot',
      album: 'B-SIDE - Radio Capital',
      artwork: [
      {src: 'icon-192.png', sizes: '192x192', type: 'image/png'},
      {src: 'icon-512.png', sizes: '512x512', type: 'image/png'}
      ]
    });
  }
}

if ('mediaSession' in navigator) {
  navigator.mediaSession.setActionHandler('play', function() {
    log('MediaSession: play');
    Engine.intent.shouldBePlaying = true;
    var t = Engine.position.current;
    if (t > 0 && audio.duration && t < audio.duration) {
      audio.currentTime = t;
    }
    audio.play();
  });
  
  navigator.mediaSession.setActionHandler('pause', function() {
    log('MediaSession: pause');
    Engine.position.current = audio.currentTime;
    Engine.intent.shouldBePlaying = false;
    Engine.intent.pausedByUser = true;
    audio.pause();
  });
  
  navigator.mediaSession.setActionHandler('seekbackward', function() {
    var t = Math.max(0, audio.currentTime - 30);
    Engine.position.current = t;
    audio.currentTime = t;
  });
  
  navigator.mediaSession.setActionHandler('seekforward', function() {
    var t = audio.currentTime + 30;
    Engine.position.current = t;
    audio.currentTime = t;
  });
  
  navigator.mediaSession.setActionHandler('seekto', function(d) {
    if (d.seekTime) {
      Engine.position.current = d.seekTime;
      audio.currentTime = d.seekTime;
    }
  });
}

// ============================================
// PWA INSTALL
// ============================================
window.addEventListener('beforeinstallprompt', function(e) {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installPrompt').classList.add('show');
});

document.getElementById('installBtn').addEventListener('click', function() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(function() {
      deferredPrompt = null;
      document.getElementById('installPrompt').classList.remove('show');
    });
  }
});

document.getElementById('installClose').addEventListener('click', function() {
  document.getElementById('installPrompt').classList.remove('show');
});

window.addEventListener('appinstalled', function() {
  document.getElementById('installPrompt').classList.remove('show');
});

// ============================================
// SERVICE WORKER
// ============================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').then(function(r) {
    log('Service Worker registered: ' + r.scope, 'success');
  }).catch(function(e) {
    log('Service Worker error: ' + e, 'error');
  });
}

// ============================================
// INITIALIZATION
// ============================================
function init() {
  log('=== B-SIDE Player v5 Initializing ===', 'success');
  
  // Initialize all subsystems
  initNetworkMonitoring();
  initPositionTracking();
  initLifecycleManagement();
  initAudioEvents();
  
  // Initial UI state
  updatePlayer();
  updateNav();
  updateFav();
  updateVolIcon();
  updateMediaSession();
  
  // Clean old saved positions (every 7 days)
  cleanOldPositions();
  
  log('=== Initialization complete ===', 'success');
  log('Network: ' + (Engine.network.type || 'unknown') + ', quality: ' + Engine.network.quality, 'network');
}

function cleanOldPositions() {
  var maxAge = 30 * 24 * 60 * 60 * 1000;
  var now = Date.now();
  var keysToRemove = [];
  
  for (var i = 0; i < localStorage.length; i++) {
    var key = localStorage.key(i);
    if (key && key.startsWith('bside-pos-')) {
      try {
        var data = JSON.parse(localStorage.getItem(key));
        if (now - data.timestamp > maxAge) {
          keysToRemove.push(key);
        }
      } catch (e) {
        keysToRemove.push(key);
      }
    }
  }
  
  keysToRemove.forEach(function(k) {
    localStorage.removeItem(k);
    log('Cleaned old position: ' + k);
  });
}

// Start the app
init();
init();
</script>
</body>
</html>
