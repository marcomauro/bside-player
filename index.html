<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#e0e5ec" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="B-SIDE">
  <title>B-SIDE</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg: #e0e5ec;
      --bg-dark: #d1d9e6;
      --text: #1a1a1a;
      --text-secondary: #5a6170;
      --accent: #1a1a1a;
      --shadow-light: #ffffff;
      --shadow-dark: #a3b1c6;
      --neu-flat: -2px -2px 5px var(--shadow-light), 2px 2px 5px var(--shadow-dark);
      --neu-pressed: inset -1px -1px 3px var(--shadow-light), inset 1px 1px 3px var(--shadow-dark);
      --neu-convex: -2px -2px 6px var(--shadow-light), 2px 2px 6px var(--shadow-dark);
    }
    
    [data-theme="dark"] {
      --bg: #2d3436;
      --bg-dark: #232526;
      --text: #ffffff;
      --text-secondary: #a0a0a0;
      --accent: #ffffff;
      --shadow-light: #3d4447;
      --shadow-dark: #1d2425;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .app {
      height: 100%;
      max-width: 430px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 20px;
      padding-bottom: 0;
    }
    
    /* Top Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 5px;
      margin-bottom: 20px;
    }
    
    .icon-btn {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 12px;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .icon-btn:active { box-shadow: var(--neu-pressed); }
    .icon-btn svg { width: 20px; height: 20px; }
    
    /* Date Picker Button */
    .date-picker-btn {
      background: var(--bg);
      border: none;
      border-radius: 12px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      box-shadow: var(--neu-flat);
      position: relative;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .date-picker-btn:active { box-shadow: var(--neu-pressed); }
    .date-picker-btn span { font-size: 0.9rem; font-weight: 600; color: var(--text); }
    .date-picker-btn svg { color: var(--text-secondary); width: 18px; height: 18px; }
    
    .date-picker-btn input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    /* Artwork */
    .artwork-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    
    .artwork {
      width: 260px;
      height: 260px;
      border-radius: 50%;
      background: var(--bg);
      box-shadow: var(--neu-convex);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    
    .artwork h1 {
      font-size: 3.2rem;
      font-weight: 800;
      letter-spacing: -2px;
      color: var(--text);
      margin-bottom: 8px;
    }
    
    .artwork p {
      font-size: 1rem;
      font-weight: 400;
      color: var(--text-secondary);
    }
    
    /* Track Info */
    .track-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 10px;
    }
    
    .track-details h2 {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .track-details p {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .fav-btn {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .fav-btn:active { box-shadow: var(--neu-pressed); }
    .fav-btn.active { color: #e74c3c; }
    .fav-btn.active svg { fill: #e74c3c; }
    .fav-btn svg { width: 22px; height: 22px; }
    
    /* Progress */
    .progress-section { padding: 10px 10px 20px; }
    
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg);
      border-radius: 3px;
      box-shadow: var(--neu-pressed);
      position: relative;
      cursor: pointer;
      touch-action: none;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
    }
    
    .progress-thumb {
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: var(--bg);
      border-radius: 50%;
      box-shadow: var(--neu-flat);
    }
    
    .time-display {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }
    
    /* Status Message */
    .status-message {
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .status-message.show { opacity: 1; }
    .status-message.error { color: #e74c3c; }
    .status-message.warning { color: #f39c12; }
    .status-message.success { color: #27ae60; }
    
    .status-spinner {
      display: inline-block;
      width: 12px;
      height: 12px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Controls */
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 15px 0 25px;
    }
    
    .ctrl-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 14px;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .ctrl-btn:active { box-shadow: var(--neu-pressed); }
    .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ctrl-btn svg { width: 18px; height: 18px; }
    
    .play-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--accent);
      box-shadow: -2px -2px 5px var(--shadow-light), 2px 2px 5px var(--shadow-dark);
      color: var(--bg);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .play-btn:active { box-shadow: -1px -1px 3px var(--shadow-light), 1px 1px 3px var(--shadow-dark); }
    .play-btn svg { width: 28px; height: 28px; fill: var(--bg); }
    
    /* Bottom Nav */
    .bottom-nav {
      background: var(--bg);
      border-radius: 24px 24px 0 0;
      box-shadow: -2px -2px 5px var(--shadow-light), 2px 2px 5px var(--shadow-dark);
      padding: 15px 30px 25px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 0 -20px;
    }
    
    .nav-item {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 14px;
      background: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      font-weight: 600;
      gap: 2px;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .nav-item.active {
      background: var(--bg);
      box-shadow: var(--neu-pressed);
      color: var(--accent);
    }
    
    .nav-item svg { width: 22px; height: 22px; }
    
    .sleep-countdown {
      font-size: 0.75rem;
      font-weight: 700;
      color: var(--accent);
    }
    
    /* Popups */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.3);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    
    .popup-overlay.show { display: flex; }
    
    .volume-popup {
      background: var(--bg);
      border-radius: 24px;
      padding: 30px;
      box-shadow: var(--neu-flat);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    
    .volume-slider {
      width: 8px;
      height: 150px;
      background: var(--bg);
      border-radius: 4px;
      box-shadow: var(--neu-pressed);
      position: relative;
      cursor: pointer;
      touch-action: none;
    }
    
    .volume-fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: var(--accent);
      border-radius: 4px;
    }
    
    .volume-fill .progress-thumb {
      top: -8px;
      right: 50%;
      transform: translateX(50%);
    }
    
    .popup-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }
    
    /* Sleep Menu */
    .sleep-menu {
      background: var(--bg);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--neu-flat);
    }
    
    .sleep-option {
      padding: 15px 40px;
      border-radius: 12px;
      background: var(--bg);
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text);
      box-shadow: var(--neu-flat);
      transition: all 0.15s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .sleep-option:last-child { margin-bottom: 0; }
    .sleep-option:active { box-shadow: var(--neu-pressed); }
    .sleep-option.selected { color: var(--accent); box-shadow: var(--neu-pressed); }
    
    /* Favorites Popup */
    .favorites-popup {
      background: var(--bg);
      border-radius: 20px;
      padding: 20px;
      box-shadow: var(--neu-flat);
      max-width: 300px;
      width: 90%;
    }
    
    .favorites-header {
      font-size: 1rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 15px;
      text-align: center;
    }
    
    .favorites-list { max-height: 250px; overflow-y: auto; }
    
    .fav-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: var(--bg);
      box-shadow: var(--neu-flat);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    .fav-item:active { box-shadow: var(--neu-pressed); }
    
    .fav-item-del {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 5px;
    }
    
    .fav-item-del:hover { color: #e74c3c; }
    .fav-item-del svg { width: 16px; height: 16px; }
    
    .favorites-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 0.9rem;
      padding: 20px;
    }
    
    /* Install Prompt */
    .install-prompt {
      display: none;
      position: fixed;
      bottom: 100px;
      left: 20px;
      right: 20px;
      background: var(--bg);
      color: var(--text);
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      box-shadow: var(--neu-flat);
      z-index: 1000;
    }
    
    .install-prompt.show { display: block; }
    .install-prompt p { margin-bottom: 16px; font-size: 0.95rem; font-weight: 500; }
    
    .install-btn {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
    }
    
    .install-close {
      background: var(--bg);
      color: var(--text-secondary);
      border: none;
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow: var(--neu-flat);
    }
    
    audio { display: none; }
  </style>
</head>
<body>
  <div class="app">
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="date-picker-btn" id="datePickerBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span id="dateDisplay">08/12/2025</span>
        <input type="date" id="datePicker">
      </div>
      <button class="icon-btn" id="menuBtn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="5" r="2"/><circle cx="12" cy="12" r="2"/><circle cx="12" cy="19" r="2"/>
        </svg>
      </button>
    </div>
    
    <!-- Artwork -->
    <div class="artwork-container">
      <div class="artwork">
        <h1>B-SIDE</h1>
        <p>Alessio Bertallot</p>
      </div>
    </div>
    
    <!-- Track Info -->
    <div class="track-info">
      <div class="track-details">
        <h2 id="episodeDate">08/12/2025</h2>
        <p>Radio Capital</p>
      </div>
      <button class="fav-btn" id="favBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </button>
    </div>
    
    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill">
          <div class="progress-thumb"></div>
        </div>
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="remainingTime">-0:00</span>
      </div>
      <div class="status-message" id="statusMessage">
        <span id="statusText"></span>
      </div>
    </div>
    
    <!-- Controls -->
    <div class="controls">
      <button class="ctrl-btn" id="prevDay">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
      </button>
      <button class="ctrl-btn" id="skipBack">-30</button>
      <button class="ctrl-btn play-btn" id="playBtn">
        <svg viewBox="0 0 24 24" id="playIcon"><polygon points="6,4 20,12 6,20"/></svg>
      </button>
      <button class="ctrl-btn" id="skipForward">+30</button>
      <button class="ctrl-btn" id="nextDay">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2zM6 18l8.5-6L6 6z"/></svg>
      </button>
    </div>
    
    <!-- Bottom Nav -->
    <div class="bottom-nav">
      <button class="nav-item" id="sleepBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="sleepIcon">
          <circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/>
        </svg>
        <span class="sleep-countdown" id="sleepCountdown" style="display:none;"></span>
      </button>
      <button class="nav-item active" id="volumeNavBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="volumeIcon">
          <path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/>
        </svg>
      </button>
      <button class="nav-item" id="themeBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
          <circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- Popups -->
  <div class="popup-overlay" id="volumeOverlay">
    <div class="volume-popup">
      <span class="popup-title">Volume</span>
      <div class="volume-slider" id="volumeSlider">
        <div class="volume-fill" id="volumeFill" style="height:100%;">
          <div class="progress-thumb"></div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="popup-overlay" id="sleepOverlay">
    <div class="sleep-menu">
      <div class="sleep-option" data-min="30">30 min</div>
      <div class="sleep-option" data-min="60">60 min</div>
      <div class="sleep-option" data-min="90">90 min</div>
      <div class="sleep-option" data-min="0">Off</div>
    </div>
  </div>
  
  <div class="popup-overlay" id="favOverlay">
    <div class="favorites-popup">
      <div class="favorites-header">Preferiti</div>
      <div class="favorites-list" id="favList"></div>
    </div>
  </div>
  
  <!-- Install Prompt -->
  <div class="install-prompt" id="installPrompt">
    <p>Installa B-SIDE sulla tua home screen</p>
    <button class="install-btn" id="installBtn">Installa</button>
    <button class="install-close" id="installClose">No grazie</button>
  </div>
  
  <audio id="audio"></audio>

  <script>
    // Elements
    const audio = document.getElementById('audio');
    const datePicker = document.getElementById('datePicker');
    const datePickerBtn = document.getElementById('datePickerBtn');
    const dateDisplay = document.getElementById('dateDisplay');
    const episodeDate = document.getElementById('episodeDate');
    const progressBar = document.getElementById('progressBar');
    const progressFill = document.getElementById('progressFill');
    const currentTime = document.getElementById('currentTime');
    const remainingTime = document.getElementById('remainingTime');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const prevDay = document.getElementById('prevDay');
    const nextDay = document.getElementById('nextDay');
    const skipBack = document.getElementById('skipBack');
    const skipForward = document.getElementById('skipForward');
    const favBtn = document.getElementById('favBtn');
    const sleepBtn = document.getElementById('sleepBtn');
    const sleepIcon = document.getElementById('sleepIcon');
    const sleepCountdown = document.getElementById('sleepCountdown');
    const volumeNavBtn = document.getElementById('volumeNavBtn');
    const volumeIcon = document.getElementById('volumeIcon');
    const themeBtn = document.getElementById('themeBtn');
    const themeIcon = document.getElementById('themeIcon');
    const volumeOverlay = document.getElementById('volumeOverlay');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeFill = document.getElementById('volumeFill');
    const sleepOverlay = document.getElementById('sleepOverlay');
    const favOverlay = document.getElementById('favOverlay');
    const favList = document.getElementById('favList');
    const menuBtn = document.getElementById('menuBtn');
    const statusMessage = document.getElementById('statusMessage');
    const statusText = document.getElementById('statusText');
    const themeColorMeta = document.getElementById('themeColor');
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');
    const installClose = document.getElementById('installClose');
    
    // State
    let isPlaying = false;
    let sleepTimer = null, sleepEndTime = null, sleepInterval = null;
    let favorites = JSON.parse(localStorage.getItem('bside-fav') || '[]');
    let retryCount = 0, retryTimer = null, lastTime = 0, wasPlaying = false;
    let deferredPrompt = null;
    

    datePickerBtn.addEventListener('click', function() {
      datePicker.showPicker();
    });

    // Theme
    const savedTheme = localStorage.getItem('bside-theme') || 'light';
    applyTheme(savedTheme);
    
    function applyTheme(t) {
      if (t === 'dark') {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
        themeColorMeta.content = '#2d3436';
      } else {
        document.documentElement.removeAttribute('data-theme');
        themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        themeColorMeta.content = '#e0e5ec';
      }
    }
    
    themeBtn.addEventListener('click', function() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const newTheme = isDark ? 'light' : 'dark';
      applyTheme(newTheme);
      localStorage.setItem('bside-theme', newTheme);
    });
    
    // Date Picker
    const today = new Date();
    datePicker.value = today.toISOString().split('T')[0];
    datePicker.max = datePicker.value;
    
    datePicker.addEventListener('change', function() {
      updatePlayer();
      updateNav();
      updateFav();
      updateMediaSession();
    });
    
    function formatDate(d) {
      const parts = d.split('-');
      return parts[2] + '/' + parts[1] + '/' + parts[0];
    }
    
    function buildUrl(d) {
      const parts = d.split('-');
      return 'https://media.capital.it/' + parts[0] + '/' + parts[1] + '/' + parts[2] + '/episodes/bertallot/bertallot_' + parts[0] + parts[1] + parts[2] + '_220000.mp3';
    }
    
    function updatePlayer() {
      const d = datePicker.value;
      audio.src = buildUrl(d);
      episodeDate.textContent = formatDate(d);
      dateDisplay.textContent = formatDate(d);
      isPlaying = false;
      updatePlayIcon(false);
      progressFill.style.width = '0%';
      currentTime.textContent = '0:00';
      remainingTime.textContent = '-0:00';
      hideStatus();
    }
    
    function updatePlayIcon(playing) {
      if (playing) {
        playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
      } else {
        playIcon.innerHTML = '<polygon points="6,4 20,12 6,20"/>';
      }
    }
    
    function updateNav() {
      const curr = new Date(datePicker.value);
      const tod = new Date();
      curr.setHours(0,0,0,0);
      tod.setHours(0,0,0,0);
      nextDay.disabled = curr >= tod;
    }
    
    function changeDay(delta) {
      const d = new Date(datePicker.value);
      d.setDate(d.getDate() + delta);
      const str = d.toISOString().split('T')[0];
      if (str <= datePicker.max) {
        datePicker.value = str;
        updatePlayer();
        updateNav();
        updateFav();
        updateMediaSession();
      }
    }
    
    prevDay.addEventListener('click', function() { changeDay(-1); });
    nextDay.addEventListener('click', function() { changeDay(1); });
    
    // Play Controls
    playBtn.addEventListener('click', function() {
      if (isPlaying) {
        audio.pause();
        updatePlayIcon(false);
      } else {
        audio.play();
        updatePlayIcon(true);
      }
      isPlaying = !isPlaying;
    });
    
    skipBack.addEventListener('click', function() { audio.currentTime -= 30; });
    skipForward.addEventListener('click', function() { audio.currentTime += 30; });
    
    // Progress
    function formatTime(s) {
      if (isNaN(s)) return '0:00';
      var m = Math.floor(s / 60);
      var sec = Math.floor(s % 60);
      return m + ':' + (sec < 10 ? '0' : '') + sec;
    }
    
    audio.addEventListener('timeupdate', function() {
      var pct = (audio.currentTime / audio.duration) * 100 || 0;
      progressFill.style.width = pct + '%';
      currentTime.textContent = formatTime(audio.currentTime);
      remainingTime.textContent = '-' + formatTime(audio.duration - audio.currentTime);
      
      if ('mediaSession' in navigator && audio.duration) {
        navigator.mediaSession.setPositionState({
          duration: audio.duration,
          playbackRate: audio.playbackRate,
          position: audio.currentTime
        });
      }
    });
    
    audio.addEventListener('loadedmetadata', function() {
      remainingTime.textContent = '-' + formatTime(audio.duration);
    });
    
    var progressDragging = false;
    
    progressBar.addEventListener('mousedown', function(e) {
      progressDragging = true;
      updateProgress(e);
    });
    
    progressBar.addEventListener('touchstart', function(e) {
      progressDragging = true;
      updateProgress(e);
    });
    
    document.addEventListener('mousemove', function(e) {
      if (progressDragging) updateProgress(e);
    });
    
    document.addEventListener('touchmove', function(e) {
      if (progressDragging) updateProgress(e);
    });
    
    document.addEventListener('mouseup', function() { progressDragging = false; });
    document.addEventListener('touchend', function() { progressDragging = false; });
    
    function updateProgress(e) {
      var rect = progressBar.getBoundingClientRect();
      var clientX = e.touches ? e.touches[0].clientX : e.clientX;
      var pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));
      if (audio.duration) {
        audio.currentTime = pct * audio.duration;
        progressFill.style.width = (pct * 100) + '%';
      }
    }
    
    // Volume
    volumeNavBtn.addEventListener('click', function() { volumeOverlay.classList.add('show'); });
    volumeOverlay.addEventListener('click', function(e) {
      if (e.target === volumeOverlay) volumeOverlay.classList.remove('show');
    });
    
    var volDrag = false;
    
    function updateVol(e) {
      var rect = volumeSlider.getBoundingClientRect();
      var clientY = e.touches ? e.touches[0].clientY : e.clientY;
      var y = clientY - rect.top;
      var pct = 1 - (y / rect.height);
      audio.volume = Math.max(0, Math.min(1, pct));
      volumeFill.style.height = (audio.volume * 100) + '%';
      updateVolIcon();
    }
    
    function updateVolIcon() {
      var v = audio.volume;
      if (v === 0) {
        volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>';
      } else if (v < 0.5) {
        volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/>';
      } else {
        volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/>';
      }
    }
    
    volumeSlider.addEventListener('mousedown', function(e) { volDrag = true; updateVol(e); });
    volumeSlider.addEventListener('touchstart', function(e) { e.preventDefault(); volDrag = true; updateVol(e); });
    document.addEventListener('mousemove', function(e) { if (volDrag) updateVol(e); });
    document.addEventListener('touchmove', function(e) { if (volDrag) { e.preventDefault(); updateVol(e); } }, { passive: false });
    document.addEventListener('mouseup', function() { volDrag = false; });
    document.addEventListener('touchend', function() { volDrag = false; });
    
    // Sleep Timer
    sleepBtn.addEventListener('click', function() { sleepOverlay.classList.add('show'); });
    sleepOverlay.addEventListener('click', function(e) {
      if (e.target === sleepOverlay) sleepOverlay.classList.remove('show');
    });
    
    var sleepOptions = document.querySelectorAll('.sleep-option');
    sleepOptions.forEach(function(opt) {
      opt.addEventListener('click', function() {
        var min = parseInt(opt.getAttribute('data-min'));
        setSleep(min);
        sleepOverlay.classList.remove('show');
        sleepOptions.forEach(function(o) { o.classList.remove('selected'); });
        if (min > 0) opt.classList.add('selected');
      });
    });
    
    function setSleep(min) {
      if (sleepTimer) clearTimeout(sleepTimer);
      if (sleepInterval) clearInterval(sleepInterval);
      
      if (min === 0) {
        sleepEndTime = null;
        sleepIcon.style.display = '';
        sleepCountdown.style.display = 'none';
        sleepBtn.classList.remove('active');
        return;
      }
      
      sleepEndTime = Date.now() + min * 60000;
      sleepBtn.classList.add('active');
      sleepIcon.style.display = 'none';
      sleepCountdown.style.display = '';
      updateSleepDisplay();
      
      sleepInterval = setInterval(updateSleepDisplay, 1000);
      sleepTimer = setTimeout(function() {
        audio.pause();
        updatePlayIcon(false);
        isPlaying = false;
        setSleep(0);
      }, min * 60000);
    }
    
    function updateSleepDisplay() {
      if (!sleepEndTime) return;
      var rem = Math.max(0, sleepEndTime - Date.now());
      if (rem === 0) { setSleep(0); return; }
      var m = Math.floor(rem / 60000);
      var s = Math.floor((rem % 60000) / 1000);
      sleepCountdown.textContent = m + ':' + (s < 10 ? '0' : '') + s;
    }
    
    // Favorites
    favBtn.addEventListener('click', function() {
      var d = datePicker.value;
      var idx = favorites.indexOf(d);
      if (idx > -1) {
        favorites.splice(idx, 1);
      } else {
        favorites.unshift(d);
      }
      localStorage.setItem('bside-fav', JSON.stringify(favorites));
      updateFav();
    });
    
    function updateFav() {
      var d = datePicker.value;
      if (favorites.indexOf(d) > -1) {
        favBtn.classList.add('active');
      } else {
        favBtn.classList.remove('active');
      }
    }
    
    menuBtn.addEventListener('click', function() {
      renderFavList();
      favOverlay.classList.add('show');
    });
    
    favOverlay.addEventListener('click', function(e) {
      if (e.target === favOverlay) favOverlay.classList.remove('show');
    });
    
    function renderFavList() {
      if (favorites.length === 0) {
        favList.innerHTML = '<div class="favorites-empty">Nessun preferito</div>';
        return;
      }
      
      var html = '';
      for (var i = 0; i < favorites.length; i++) {
        var d = favorites[i];
        html += '<div class="fav-item" data-date="' + d + '">';
        html += '<span>' + formatDate(d) + '</span>';
        html += '<button class="fav-item-del" data-date="' + d + '">';
        html += '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">';
        html += '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>';
        html += '</svg></button></div>';
      }
      favList.innerHTML = html;
      
      var items = favList.querySelectorAll('.fav-item');
      items.forEach(function(item) {
        item.addEventListener('click', function(e) {
          if (!e.target.closest('.fav-item-del')) {
            datePicker.value = item.getAttribute('data-date');
            updatePlayer();
            updateNav();
            updateFav();
            updateMediaSession();
            favOverlay.classList.remove('show');
          }
        });
      });
      
      var delBtns = favList.querySelectorAll('.fav-item-del');
      delBtns.forEach(function(btn) {
        btn.addEventListener('click', function(e) {
          e.stopPropagation();
          var d = btn.getAttribute('data-date');
          var idx = favorites.indexOf(d);
          if (idx > -1) favorites.splice(idx, 1);
          localStorage.setItem('bside-fav', JSON.stringify(favorites));
          updateFav();
          renderFavList();
        });
      });
    }
    
    // Status Messages
    function showStatus(msg, type, withSpinner) {
      statusMessage.className = 'status-message show ' + (type || '');
      if (withSpinner) {
        statusText.innerHTML = '<span class="status-spinner"></span> ' + msg;
      } else {
        statusText.textContent = msg;
      }
    }
    
    function hideStatus() {
      statusMessage.classList.remove('show');
      setTimeout(function() { statusText.innerHTML = ''; }, 300);
    }
    
    // Audio Errors
    audio.addEventListener('error', function() {
      lastTime = audio.currentTime || 0;
      wasPlaying = isPlaying;
      updatePlayIcon(false);
      isPlaying = false;
      
      if (!navigator.onLine) {
        showStatus('Nessuna connessione', 'error');
        return;
      }
      
      fetch(audio.src, { method: 'HEAD' })
        .then(function(r) {
          if (r.status === 404) {
            showStatus('Puntata non disponibile', 'error');
          } else {
            retry();
          }
        })
        .catch(function() { retry(); });
    });
    
    audio.addEventListener('loadeddata', function() { hideStatus(); retryCount = 0; });
    audio.addEventListener('waiting', function() { if (isPlaying) showStatus('Buffering...', 'warning', true); });
    audio.addEventListener('playing', function() { hideStatus(); retryCount = 0; });
    
    function retry() {
      if (retryCount >= 5) {
        showStatus('Connessione fallita', 'error');
        return;
      }
      retryCount++;
      showStatus('Riconnessione... (' + retryCount + '/5)', 'warning', true);
      if (retryTimer) clearTimeout(retryTimer);
      retryTimer = setTimeout(function() {
        var src = audio.src;
        audio.src = '';
        audio.src = src;
        audio.currentTime = lastTime;
        if (wasPlaying) {
          audio.play().then(function() {
            isPlaying = true;
            updatePlayIcon(true);
          }).catch(function() { retry(); });
        }
      }, Math.min(5000 * retryCount, 20000));
    }
    
    window.addEventListener('online', function() {
      showStatus('Connessione ripristinata', 'success');
      setTimeout(function() {
        hideStatus();
        if (wasPlaying) { retryCount = 0; retry(); }
      }, 2000);
    });
    
    window.addEventListener('offline', function() {
      showStatus('Nessuna connessione', 'error');
    });
    
    // Media Session
    function updateMediaSession() {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: 'Puntata del ' + formatDate(datePicker.value),
          artist: 'Alessio Bertallot',
          album: 'B-SIDE - Radio Capital',
          artwork: [
            { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icon-512.png', sizes: '512x512', type: 'image/png' }
          ]
        });
      }
    }
    
    if ('mediaSession' in navigator) {
      navigator.mediaSession.setActionHandler('play', function() { audio.play(); updatePlayIcon(true); isPlaying = true; });
      navigator.mediaSession.setActionHandler('pause', function() { audio.pause(); updatePlayIcon(false); isPlaying = false; });
      navigator.mediaSession.setActionHandler('seekbackward', function() { audio.currentTime -= 30; });
      navigator.mediaSession.setActionHandler('seekforward', function() { audio.currentTime += 30; });
      navigator.mediaSession.setActionHandler('seekto', function(d) { if (d.seekTime) audio.currentTime = d.seekTime; });
    }
    
    // PWA Install
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('show');
    });
    
    installBtn.addEventListener('click', function() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(function() {
          deferredPrompt = null;
          installPrompt.classList.remove('show');
        });
      }
    });
    
    installClose.addEventListener('click', function() { installPrompt.classList.remove('show'); });
    window.addEventListener('appinstalled', function() { installPrompt.classList.remove('show'); });
    
    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(function(reg) { console.log('SW registrato:', reg.scope); })
        .catch(function(err) { console.log('SW errore:', err); });
    }
    
    // Init
    updatePlayer();
    updateNav();
    updateFav();
    updateVolIcon();
    updateMediaSession();
  </script>
</body>
</html>
