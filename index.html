<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="B-SIDE">
  <title>B-SIDE</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-main: #fafafa;
      --bg-card: #fff;
      --bg-player: #f5f5f5;
      --text-primary: #1a1a1a;
      --text-secondary: #666;
      --text-tertiary: #999;
      --border-color: #e0e0e0;
      --slider-bg: #ddd;
      --slider-fill: #1a1a1a;
      --shadow: rgba(0,0,0,0.08);
      --accent: #4a90d9;
    }
    
    [data-theme="dark"] {
      --bg-main: #121212;
      --bg-card: #1e1e1e;
      --bg-player: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #aaa;
      --text-tertiary: #777;
      --border-color: #444;
      --slider-bg: #444;
      --slider-fill: #fff;
      --shadow: rgba(0,0,0,0.3);
      --accent: #6ab0ff;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      transition: background 0.3s;
    }
    
    .container {
      background: var(--bg-card);
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px var(--shadow);
      width: 100%;
      max-width: 400px;
      transition: background 0.3s, box-shadow 0.3s;
    }
    
    h1 { font-size: 1.5rem; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; text-align: center; }
    .subtitle { font-size: 0.9rem; color: var(--text-secondary); text-align: center; margin-bottom: 4px; }
    .episode { font-size: 0.8rem; color: var(--text-tertiary); text-align: center; margin-bottom: 24px; }
    
    .date-section { margin-bottom: 24px; }
    .date-row { display: flex; gap: 12px; align-items: center; }
    .date-row input[type="date"] { flex: 1; }
    
    label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 8px; }
    
    input[type="date"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      color: var(--text-primary);
      background: var(--bg-card);
      cursor: pointer;
      transition: border-color 0.2s;
    }
    input[type="date"]:hover { border-color: var(--text-tertiary); }
    input[type="date"]:focus { outline: none; border-color: var(--text-primary); }
    
    .player-section { background: var(--bg-player); border-radius: 8px; padding: 20px; transition: background 0.3s; }
    .controls { display: flex; align-items: center; justify-content: center; gap: 20px; margin-bottom: 16px; }
    
    .skip-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .skip-btn:hover { background: var(--bg-player); border-color: var(--text-tertiary); }
    
    .play-btn {
      background: transparent;
      border: 1px solid var(--border-color);
      border-radius: 50%;
      width: 64px;
      height: 64px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .play-btn:hover { background: var(--bg-player); border-color: var(--text-tertiary); transform: scale(1.05); }
    
    /* Settings Row */
    .settings-row {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .setting-btn {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      height: 40px;
      padding: 0 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--text-primary);
      transition: all 0.2s;
      position: relative;
    }
    .setting-btn:hover { background: var(--bg-player); }
    .setting-btn.active { border-color: var(--accent); color: var(--accent); }
    .setting-btn svg { width: 18px; height: 18px; }
    
    /* Sleep Menu */
    .sleep-menu {
      display: none;
      position: absolute;
      bottom: 48px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      box-shadow: 0 4px 12px var(--shadow);
      overflow: hidden;
      z-index: 100;
    }
    .sleep-menu.show { display: block; }
    .sleep-option {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text-primary);
      white-space: nowrap;
      transition: background 0.2s;
    }
    .sleep-option:hover { background: var(--bg-player); }
    .sleep-option.selected { color: var(--accent); font-weight: 500; }
    
    .progress-container { width: 100%; margin-bottom: 8px; }
    
    #progressSlider {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, var(--slider-fill) 0%, var(--slider-bg) 0%);
      border-radius: 2px;
      cursor: pointer;
    }
    #progressSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--slider-fill); border-radius: 50%; cursor: pointer; }
    #progressSlider::-moz-range-thumb { width: 12px; height: 12px; background: var(--slider-fill); border-radius: 50%; cursor: pointer; border: none; }
    
    .time-display { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 12px; }
    .volume-control { display: flex; align-items: center; gap: 8px; }
    .volume-icon { font-size: 1.1rem; cursor: pointer; user-select: none; line-height: 1; color: var(--text-primary); }
    
    #volumeSlider {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--slider-bg);
      border-radius: 2px;
      cursor: pointer;
    }
    #volumeSlider::-webkit-slider-thumb { -webkit-appearance: none; width: 12px; height: 12px; background: var(--slider-fill); border-radius: 50%; cursor: pointer; }
    #volumeSlider::-moz-range-thumb { width: 12px; height: 12px; background: var(--slider-fill); border-radius: 50%; cursor: pointer; border: none; }
    
    audio { display: none; }
    
    .error-message { background: #ff4444; color: #fff; padding: 12px 16px; border-radius: 8px; font-size: 0.85rem; margin-bottom: 16px; display: none; text-align: center; }
    .error-message.show { display: block; }
    [data-theme="dark"] .error-message { background: #cc3333; }
    
    .install-prompt { display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: #333; color: #fff; padding: 16px; border-radius: 12px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2); z-index: 1000; }
    .install-prompt.show { display: block; }
    .install-prompt p { margin-bottom: 12px; font-size: 0.9rem; }
    .install-btn { background: #fff; color: #333; border: none; padding: 10px 24px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; margin-right: 8px; }
    .install-close { background: transparent; color: #999; border: 1px solid #666; padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>B-SIDE</h1>
    <p class="subtitle">Alessio Bertallot</p>
    <p class="episode" id="episodeDate">Puntata del —</p>
    
    <div class="date-section">
      <label for="datePicker">Seleziona data</label>
      <div class="date-row">
        <input type="date" id="datePicker">
      </div>
    </div>
    
    <div class="error-message" id="errorMessage">Puntata non disponibile per questa data</div>
    
    <div class="player-section">
      <div class="controls">
        <button class="skip-btn" id="skipBack">-30s</button>
        <button class="play-btn" id="playBtn">▶</button>
        <button class="skip-btn" id="skipForward">+30s</button>
      </div>
      
      <div class="settings-row">
        <button class="setting-btn" id="themeToggle">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
            <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>
          </svg>
        </button>
        <button class="setting-btn" id="sleepBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"/>
            <polyline points="12 6 12 12 16 14"/>
          </svg>
          <span id="sleepLabel">Sleep</span>
          <div class="sleep-menu" id="sleepMenu">
            <div class="sleep-option" data-minutes="30">30 min</div>
            <div class="sleep-option" data-minutes="60">60 min</div>
            <div class="sleep-option" data-minutes="90">90 min</div>
            <div class="sleep-option" data-minutes="0">Off</div>
          </div>
        </button>
      </div>
      
      <audio id="audioPlayer"></audio>
      <div class="progress-container">
        <input type="range" id="progressSlider" min="0" max="100" step="0.1" value="0">
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="duration">0:00</span>
      </div>
      <div class="volume-control">
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
        <span class="volume-icon" id="volumeIcon"></span>
      </div>
    </div>
  </div>
  
  <div class="install-prompt" id="installPrompt">
    <p>Installa B-SIDE sulla tua home screen</p>
    <button class="install-btn" id="installBtn">Installa</button>
    <button class="install-close" id="installClose">No grazie</button>
  </div>

  <script>
    const datePicker = document.getElementById('datePicker');
    const audioPlayer = document.getElementById('audioPlayer');
    const episodeDate = document.getElementById('episodeDate');
    const skipBack = document.getElementById('skipBack');
    const skipForward = document.getElementById('skipForward');
    const playBtn = document.getElementById('playBtn');
    const progressSlider = document.getElementById('progressSlider');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeIcon = document.getElementById('volumeIcon');
    const errorMessage = document.getElementById('errorMessage');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeColorMeta = document.getElementById('themeColor');
    const sleepBtn = document.getElementById('sleepBtn');
    const sleepMenu = document.getElementById('sleepMenu');
    const sleepLabel = document.getElementById('sleepLabel');
    const sleepOptions = document.querySelectorAll('.sleep-option');
    
    let isPlaying = false, lastVolume = 1, isDragging = false;
    let sleepTimer = null, sleepEndTime = null, sleepCountdown = null;
    
    // Theme
    const savedTheme = localStorage.getItem('bside-theme') || 'light';
    if (savedTheme === 'dark') {
      document.documentElement.setAttribute('data-theme', 'dark');
      themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
      themeColorMeta.setAttribute('content', '#121212');
    }
    
    themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      if (isDark) {
        document.documentElement.removeAttribute('data-theme');
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
        themeColorMeta.setAttribute('content', '#ffffff');
        localStorage.setItem('bside-theme', 'light');
      } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        themeColorMeta.setAttribute('content', '#121212');
        localStorage.setItem('bside-theme', 'dark');
      }
      updateProgressBackground(progressSlider.value);
    });
    
    // Sleep Timer
    sleepBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sleepMenu.classList.toggle('show');
    });
    
    document.addEventListener('click', (e) => {
      if (!sleepBtn.contains(e.target)) {
        sleepMenu.classList.remove('show');
      }
    });
    
    sleepOptions.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const minutes = parseInt(option.dataset.minutes);
        setSleepTimer(minutes);
        sleepMenu.classList.remove('show');
        
        sleepOptions.forEach(o => o.classList.remove('selected'));
        if (minutes > 0) option.classList.add('selected');
      });
    });
    
    function setSleepTimer(minutes) {
      // Clear existing timers
      if (sleepTimer) clearTimeout(sleepTimer);
      if (sleepCountdown) clearInterval(sleepCountdown);
      
      if (minutes === 0) {
        sleepEndTime = null;
        sleepLabel.textContent = 'Sleep';
        sleepBtn.classList.remove('active');
        return;
      }
      
      sleepEndTime = Date.now() + minutes * 60 * 1000;
      sleepBtn.classList.add('active');
      
      // Update countdown display
      updateSleepDisplay();
      sleepCountdown = setInterval(updateSleepDisplay, 1000);
      
      // Set timer to stop audio
      sleepTimer = setTimeout(() => {
        audioPlayer.pause();
        playBtn.textContent = '▶';
        isPlaying = false;
        setSleepTimer(0);
      }, minutes * 60 * 1000);
    }
    
    function updateSleepDisplay() {
      if (!sleepEndTime) return;
      
      const remaining = Math.max(0, sleepEndTime - Date.now());
      if (remaining === 0) {
        setSleepTimer(0);
        return;
      }
      
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      sleepLabel.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    const today = new Date();
    datePicker.value = today.toISOString().split('T')[0];
    datePicker.max = today.toISOString().split('T')[0];
    
    function buildUrl(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `https://media.capital.it/${year}/${month}/${day}/episodes/bertallot/bertallot_${year}${month}${day}_220000.mp3`;
    }
    
    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }
    
    function formatTime(sec) {
      if (isNaN(sec)) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }
    
    function updatePlayer() {
      const dateValue = datePicker.value;
      if (dateValue) {
        audioPlayer.src = buildUrl(dateValue);
        episodeDate.textContent = `Puntata del ${formatDate(dateValue)}`;
        isPlaying = false;
        playBtn.textContent = '▶';
        progressSlider.value = 0;
        updateProgressBackground(0);
        currentTimeEl.textContent = '0:00';
        durationEl.textContent = '0:00';
        errorMessage.classList.remove('show');
      }
    }
    
    function updateProgressBackground(pct) {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const fillColor = isDark ? '#fff' : '#1a1a1a';
      const bgColor = isDark ? '#444' : '#ddd';
      progressSlider.style.background = `linear-gradient(to right, ${fillColor} ${pct}%, ${bgColor} ${pct}%)`;
    }
    
    audioPlayer.addEventListener('error', () => { errorMessage.classList.add('show'); playBtn.textContent = '▶'; isPlaying = false; });
    audioPlayer.addEventListener('loadeddata', () => { errorMessage.classList.remove('show'); });
    
    playBtn.addEventListener('click', () => {
      if (isPlaying) { audioPlayer.pause(); playBtn.textContent = '▶'; }
      else { audioPlayer.play(); playBtn.textContent = '❚❚'; }
      isPlaying = !isPlaying;
    });
    
    audioPlayer.addEventListener('timeupdate', () => {
      if (!isDragging) {
        const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
        progressSlider.value = pct;
        updateProgressBackground(pct);
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        if ('mediaSession' in navigator && audioPlayer.duration) {
          navigator.mediaSession.setPositionState({ duration: audioPlayer.duration, playbackRate: audioPlayer.playbackRate, position: audioPlayer.currentTime });
        }
      }
    });
    
    audioPlayer.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(audioPlayer.duration);
      progressSlider.max = 100;
      if ('mediaSession' in navigator) {
        navigator.mediaSession.setPositionState({ duration: audioPlayer.duration, playbackRate: 1, position: 0 });
      }
    });
    
    progressSlider.addEventListener('input', () => {
      isDragging = true;
      const pct = progressSlider.value;
      updateProgressBackground(pct);
      currentTimeEl.textContent = formatTime((pct / 100) * audioPlayer.duration);
    });
    
    progressSlider.addEventListener('change', () => {
      audioPlayer.currentTime = (progressSlider.value / 100) * audioPlayer.duration;
      isDragging = false;
    });
    
    datePicker.addEventListener('change', () => { updatePlayer(); updateMediaSessionMetadata(); });
    skipBack.addEventListener('click', () => audioPlayer.currentTime -= 30);
    skipForward.addEventListener('click', () => audioPlayer.currentTime += 30);
    
    volumeSlider.addEventListener('input', () => { audioPlayer.volume = volumeSlider.value; updateVolumeIcon(); });
    
    volumeIcon.addEventListener('click', () => {
      if (audioPlayer.volume > 0) { lastVolume = audioPlayer.volume; audioPlayer.volume = 0; volumeSlider.value = 0; }
      else { audioPlayer.volume = lastVolume; volumeSlider.value = lastVolume; }
      updateVolumeIcon();
    });
    
    function updateVolumeIcon() {
      const v = audioPlayer.volume;
      if (v === 0) volumeIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
      else if (v < 0.5) volumeIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>';
      else volumeIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/></svg>';
    }
    
    // PWA Install
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');
    const installClose = document.getElementById('installClose');
    
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installPrompt.classList.add('show'); });
    installBtn.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installPrompt.classList.remove('show'); } });
    installClose.addEventListener('click', () => { installPrompt.classList.remove('show'); });
    window.addEventListener('appinstalled', () => { installPrompt.classList.remove('show'); });
    
    // Media Session API
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: 'B-SIDE',
        artist: 'Alessio Bertallot',
        album: 'Radio Capital',
        artwork: [
          { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: 'icon-512.png', sizes: '512x512', type: 'image/png' }
        ]
      });
      
      navigator.mediaSession.setActionHandler('play', () => { audioPlayer.play(); playBtn.textContent = '❚❚'; isPlaying = true; });
      navigator.mediaSession.setActionHandler('pause', () => { audioPlayer.pause(); playBtn.textContent = '▶'; isPlaying = false; });
      navigator.mediaSession.setActionHandler('seekbackward', () => { audioPlayer.currentTime -= 30; });
      navigator.mediaSession.setActionHandler('seekforward', () => { audioPlayer.currentTime += 30; });
      navigator.mediaSession.setActionHandler('seekto', (d) => { if (d.seekTime) audioPlayer.currentTime = d.seekTime; });
    }
    
    function updateMediaSessionMetadata() {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: `Puntata del ${formatDate(datePicker.value)}`,
          artist: 'Alessio Bertallot',
          album: 'B-SIDE - Radio Capital',
          artwork: [
            { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icon-512.png', sizes: '512x512', type: 'image/png' }
          ]
        });
      }
    }
    
    updateVolumeIcon();
    updatePlayer();
    updateMediaSessionMetadata();
    
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then((reg) => console.log('Service Worker registrato:', reg.scope))
        .catch((err) => console.log('Service Worker errore:', err));
    }
  </script>
</body>
</html>
