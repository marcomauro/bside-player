<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#000000" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="B-SIDE">
  <title>B-SIDE</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-main: #000000;
      --bg-elevated: #1a1a1a;
      --bg-button: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: rgba(255,255,255,0.7);
      --text-tertiary: rgba(255,255,255,0.5);
      --accent: #0A84FF;
      --accent-glow: rgba(10,132,255,0.3);
      --border-color: #333;
      --slider-bg: rgba(255,255,255,0.2);
    }
    
    [data-theme="light"] {
      --bg-main: #f5f5f7;
      --bg-elevated: #ffffff;
      --bg-button: #e5e5e5;
      --text-primary: #000000;
      --text-secondary: rgba(0,0,0,0.7);
      --text-tertiary: rgba(0,0,0,0.5);
      --accent: #007AFF;
      --accent-glow: rgba(0,122,255,0.2);
      --border-color: #d0d0d0;
      --slider-bg: rgba(0,0,0,0.15);
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-primary);
      -webkit-font-smoothing: antialiased;
    }
    
    .container {
      width: 100%;
      max-width: 380px;
      display: flex;
      flex-direction: column;
      gap: 32px;
    }
    
    /* Header */
    .header { text-align: center; }
    .header h1 { font-size: 2rem; font-weight: 700; letter-spacing: -0.5px; margin-bottom: 6px; }
    .header .artist { font-size: 1rem; font-weight: 400; color: var(--text-secondary); margin-bottom: 4px; }
    .header .episode { font-size: 0.85rem; font-weight: 300; color: var(--text-tertiary); }
    
    /* Date Picker */
    .date-picker-wrapper { display: flex; justify-content: center; }
    .date-picker-btn {
      background: var(--bg-button);
      border: none;
      border-radius: 50px;
      padding: 12px 24px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .date-picker-btn:hover { background: var(--bg-elevated); }
    .date-picker-btn span { font-size: 0.95rem; font-weight: 500; color: var(--text-primary); }
    .date-picker-btn svg { width: 16px; height: 16px; color: var(--text-tertiary); }
    .date-picker-btn input {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    /* Error & Connection */
    .error-message { background: #FF453A; color: #fff; padding: 12px 20px; border-radius: 12px; font-size: 0.85rem; font-weight: 500; text-align: center; display: none; }
    .error-message.show { display: block; }
    .connection-status { background: #FF9F0A; color: #fff; padding: 10px 20px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; display: none; align-items: center; justify-content: center; gap: 10px; }
    .connection-status.show { display: flex; }
    .connection-status.offline { background: #FF453A; }
    .connection-status.online { background: #30D158; }
    .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Player Section */
    .player-section { display: flex; flex-direction: column; gap: 24px; }
    
    /* Progress */
    .progress-section { display: flex; flex-direction: column; gap: 8px; }
    .progress-bar-container { width: 100%; height: 4px; background: var(--slider-bg); border-radius: 2px; position: relative; cursor: pointer; }
    .progress-bar-fill { height: 100%; background: var(--accent); border-radius: 2px; width: 0%; position: relative; }
    .progress-bar-thumb { position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: var(--accent); border-radius: 50%; box-shadow: 0 0 10px var(--accent-glow); }
    .time-display { display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: 500; color: var(--text-tertiary); font-variant-numeric: tabular-nums; }
    
    /* Controls */
    .controls { display: flex; align-items: center; justify-content: center; gap: 12px; }
    .nav-btn {
      background: var(--bg-button);
      border: none;
      width: 44px; height: 44px;
      min-width: 44px; min-height: 44px;
      flex-shrink: 0;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .nav-btn:hover { background: var(--bg-elevated); transform: scale(1.05); }
    .nav-btn:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
    .nav-btn svg { width: 18px; height: 18px; }
    
    .skip-btn {
      background: var(--bg-button);
      border: none;
      border-radius: 50px;
      padding: 12px 16px;
      min-width: 56px; height: 44px;
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Inter', sans-serif;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
      transition: all 0.2s;
    }
    .skip-btn:hover { background: var(--bg-elevated); transform: scale(1.05); }
    
    .play-btn {
      background: var(--accent);
      border: none;
      border-radius: 50%;
      width: 72px; height: 72px;
      min-width: 72px; min-height: 72px;
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      transition: all 0.2s;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .play-btn:hover { transform: scale(1.08); box-shadow: 0 6px 30px var(--accent-glow); }
    .play-btn svg { width: 28px; height: 28px; fill: #fff; }
    
    /* Bottom Bar */
    .bottom-bar { display: flex; justify-content: space-between; align-items: center; padding-top: 8px; }
    .volume-btn {
      background: var(--bg-button);
      border: none;
      width: 44px; height: 44px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      transition: all 0.2s;
      position: relative;
    }
    .volume-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .volume-btn svg { width: 20px; height: 20px; }
    
    .settings-group { display: flex; gap: 12px; }
    .setting-btn {
      background: var(--bg-button);
      border: none;
      height: 44px;
      padding: 0 16px;
      border-radius: 50px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      color: var(--text-secondary);
      font-family: 'Inter', sans-serif;
      font-size: 0.8rem;
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
    }
    .setting-btn:hover { background: var(--bg-elevated); color: var(--text-primary); }
    .setting-btn.active { color: var(--accent); }
    .setting-btn svg { width: 18px; height: 18px; }
    
    /* Sleep Menu */
    .sleep-menu {
      display: none;
      position: absolute;
      bottom: 52px;
      right: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      overflow: hidden;
      z-index: 100;
      min-width: 120px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
    }
    .sleep-menu.show { display: block; }
    .sleep-option { padding: 14px 20px; cursor: pointer; font-size: 0.9rem; font-weight: 500; color: var(--text-primary); transition: background 0.15s; text-align: center; }
    .sleep-option:hover { background: var(--bg-button); }
    .sleep-option.selected { color: var(--accent); }
    
    /* Volume Popup */
    .volume-popup {
      display: none;
      position: absolute;
      bottom: 52px;
      left: 0;
      background: var(--bg-elevated);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      padding: 20px 16px;
      z-index: 100;
      box-shadow: 0 10px 40px rgba(0,0,0,0.4);
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }
    .volume-popup.show { display: flex; }
    .volume-slider-vertical { width: 4px; height: 120px; background: var(--slider-bg); border-radius: 2px; position: relative; cursor: pointer; }
    .volume-slider-fill { position: absolute; bottom: 0; width: 100%; background: var(--accent); border-radius: 2px; }
    .volume-slider-thumb { position: absolute; top: -6px; left: 50%; transform: translateX(-50%); width: 12px; height: 12px; background: #fff; border-radius: 50%; }
    
    /* Install Prompt */
    .install-prompt { display: none; position: fixed; bottom: 20px; left: 20px; right: 20px; background: var(--bg-elevated); color: var(--text-primary); padding: 20px; border-radius: 16px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1000; border: 1px solid var(--border-color); }
    .install-prompt.show { display: block; }
    .install-prompt p { margin-bottom: 16px; font-size: 0.95rem; font-weight: 500; }
    .install-btn { background: var(--accent); color: #fff; border: none; padding: 12px 28px; border-radius: 50px; font-size: 0.9rem; font-weight: 600; cursor: pointer; margin-right: 10px; }
    .install-close { background: var(--bg-button); color: var(--text-secondary); border: none; padding: 12px 20px; border-radius: 50px; font-size: 0.9rem; font-weight: 500; cursor: pointer; }
    
    audio { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>B-SIDE</h1>
      <p class="artist">Alessio Bertallot</p>
      <p class="episode" id="episodeDate">Puntata del â€”</p>
    </header>
    
    <div class="date-picker-wrapper">
      <div class="date-picker-btn" id="datePickerBtn">
        <span id="dateDisplay">Seleziona Data</span>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
        <input type="date" id="datePicker">
      </div>
    </div>
    
    <div class="error-message" id="errorMessage">Puntata non disponibile per questa data</div>
    <div class="connection-status" id="connectionStatus">
      <div class="spinner"></div>
      <span id="connectionText">Riconnessione...</span>
    </div>
    
    <div class="player-section">
      <div class="progress-section">
        <div class="progress-bar-container" id="progressContainer">
          <div class="progress-bar-fill" id="progressFill">
            <div class="progress-bar-thumb"></div>
          </div>
        </div>
        <div class="time-display">
          <span id="currentTime">0:00</span>
          <span id="remainingTime">-0:00</span>
        </div>
      </div>
      
      <div class="controls">
        <button class="nav-btn" id="prevDay">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>
        </button>
        <button class="skip-btn" id="skipBack">-30</button>
        <button class="play-btn" id="playBtn">
          <svg viewBox="0 0 24 24" id="playIcon"><polygon points="6,4 20,12 6,20"/></svg>
        </button>
        <button class="skip-btn" id="skipForward">+30</button>
        <button class="nav-btn" id="nextDay">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M16 6h2v12h-2zM6 18l8.5-6L6 6z"/></svg>
        </button>
      </div>
      
      <audio id="audioPlayer"></audio>
      
      <div class="bottom-bar">
        <button class="volume-btn" id="volumeBtn">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="volumeIcon">
            <path d="M11 5L6 9H2v6h4l5 4V5z"/>
            <path d="M15.54 8.46a5 5 0 010 7.07"/>
            <path d="M19.07 4.93a10 10 0 010 14.14"/>
          </svg>
          <div class="volume-popup" id="volumePopup">
            <div class="volume-slider-vertical" id="volumeSliderContainer">
              <div class="volume-slider-fill" id="volumeSliderFill" style="height: 100%;">
                <div class="volume-slider-thumb"></div>
              </div>
            </div>
          </div>
        </button>
        
        <div class="settings-group">
          <button class="setting-btn" id="sleepBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
              <polyline points="12 6 12 12 16 14"/>
            </svg>
            <span id="sleepLabel">Sleep</span>
            <div class="sleep-menu" id="sleepMenu">
              <div class="sleep-option" data-minutes="30">30 min</div>
              <div class="sleep-option" data-minutes="60">60 min</div>
              <div class="sleep-option" data-minutes="90">90 min</div>
              <div class="sleep-option" data-minutes="0">Off</div>
            </div>
          </button>
          <button class="setting-btn" id="themeToggle">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
              <circle cx="12" cy="12" r="5"/>
              <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
              <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="install-prompt" id="installPrompt">
    <p>Installa B-SIDE sulla tua home screen</p>
    <button class="install-btn" id="installBtn">Installa</button>
    <button class="install-close" id="installClose">No grazie</button>
  </div>

  <script>
    const datePicker = document.getElementById('datePicker');
    const datePickerBtn = document.getElementById('datePickerBtn');
    const dateDisplay = document.getElementById('dateDisplay');
    const audioPlayer = document.getElementById('audioPlayer');
    const episodeDate = document.getElementById('episodeDate');
    const skipBack = document.getElementById('skipBack');
    const skipForward = document.getElementById('skipForward');
    const prevDay = document.getElementById('prevDay');
    const nextDay = document.getElementById('nextDay');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const currentTimeEl = document.getElementById('currentTime');
    const remainingTimeEl = document.getElementById('remainingTime');
    const volumeBtn = document.getElementById('volumeBtn');
    const volumePopup = document.getElementById('volumePopup');
    const volumeSliderContainer = document.getElementById('volumeSliderContainer');
    const volumeSliderFill = document.getElementById('volumeSliderFill');
    const volumeIcon = document.getElementById('volumeIcon');
    const errorMessage = document.getElementById('errorMessage');
    const connectionStatus = document.getElementById('connectionStatus');
    const connectionText = document.getElementById('connectionText');
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const themeColorMeta = document.getElementById('themeColor');
    const sleepBtn = document.getElementById('sleepBtn');
    const sleepMenu = document.getElementById('sleepMenu');
    const sleepLabel = document.getElementById('sleepLabel');
    const sleepOptions = document.querySelectorAll('.sleep-option');
    
    let isPlaying = false, lastVolume = 1, isDragging = false;
    let sleepTimer = null, sleepEndTime = null, sleepCountdown = null;
    let retryCount = 0, retryTimer = null, lastPlaybackTime = 0, wasPlayingBeforeError = false;
    
    // Theme
    const savedTheme = localStorage.getItem('bside-theme') || 'dark';
    applyTheme(savedTheme);
    
    function applyTheme(theme) {
      if (theme === 'light') {
        document.documentElement.setAttribute('data-theme', 'light');
        themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
        themeColorMeta.setAttribute('content', '#f5f5f7');
      } else {
        document.documentElement.removeAttribute('data-theme');
        themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
        themeColorMeta.setAttribute('content', '#000000');
      }
    }
    
    themeToggle.addEventListener('click', () => {
      const isLight = document.documentElement.getAttribute('data-theme') === 'light';
      const newTheme = isLight ? 'dark' : 'light';
      applyTheme(newTheme);
      localStorage.setItem('bside-theme', newTheme);
    });
    
    // Date Picker
    const today = new Date();
    datePicker.value = today.toISOString().split('T')[0];
    datePicker.max = today.toISOString().split('T')[0];
    
    datePickerBtn.addEventListener('click', () => {
      datePicker.showPicker();
    });
    
    datePicker.addEventListener('change', () => {
      updatePlayer();
      updateMediaSessionMetadata();
      updateNavButtons();
    });
    
    // Sleep Timer
    sleepBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      sleepMenu.classList.toggle('show');
      volumePopup.classList.remove('show');
    });
    
    document.addEventListener('click', (e) => {
      if (!sleepBtn.contains(e.target)) sleepMenu.classList.remove('show');
      if (!volumeBtn.contains(e.target)) volumePopup.classList.remove('show');
    });
    
    sleepOptions.forEach(option => {
      option.addEventListener('click', (e) => {
        e.stopPropagation();
        const minutes = parseInt(option.dataset.minutes);
        setSleepTimer(minutes);
        sleepMenu.classList.remove('show');
        sleepOptions.forEach(o => o.classList.remove('selected'));
        if (minutes > 0) option.classList.add('selected');
      });
    });
    
    function setSleepTimer(minutes) {
      if (sleepTimer) clearTimeout(sleepTimer);
      if (sleepCountdown) clearInterval(sleepCountdown);
      
      if (minutes === 0) {
        sleepEndTime = null;
        sleepLabel.textContent = 'Sleep';
        sleepBtn.classList.remove('active');
        return;
      }
      
      sleepEndTime = Date.now() + minutes * 60 * 1000;
      sleepBtn.classList.add('active');
      updateSleepDisplay();
      sleepCountdown = setInterval(updateSleepDisplay, 1000);
      
      sleepTimer = setTimeout(() => {
        audioPlayer.pause();
        updatePlayButton(false);
        isPlaying = false;
        setSleepTimer(0);
      }, minutes * 60 * 1000);
    }
    
    function updateSleepDisplay() {
      if (!sleepEndTime) return;
      const remaining = Math.max(0, sleepEndTime - Date.now());
      if (remaining === 0) { setSleepTimer(0); return; }
      const mins = Math.floor(remaining / 60000);
      const secs = Math.floor((remaining % 60000) / 1000);
      sleepLabel.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }
    
    function pauseSleepTimer() {
      if (sleepEndTime && sleepCountdown) {
        clearInterval(sleepCountdown);
        sleepCountdown = null;
        if (sleepTimer) { clearTimeout(sleepTimer); sleepTimer = null; }
      }
    }
    
    function resumeSleepTimer() {
      if (sleepEndTime) {
        const remaining = sleepEndTime - Date.now();
        if (remaining > 0) {
          sleepCountdown = setInterval(updateSleepDisplay, 1000);
          sleepTimer = setTimeout(() => {
            audioPlayer.pause();
            updatePlayButton(false);
            isPlaying = false;
            setSleepTimer(0);
          }, remaining);
        } else { setSleepTimer(0); }
      }
    }
    
    // Volume
    volumeBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      volumePopup.classList.toggle('show');
      sleepMenu.classList.remove('show');
    });
    
    let volumeDragging = false;
    
    function updateVolumeFromEvent(e) {
      const rect = volumeSliderContainer.getBoundingClientRect();
      let clientY;
      if (e.touches) {
        clientY = e.touches[0].clientY;
      } else {
        clientY = e.clientY;
      }
      const y = clientY - rect.top;
      const pct = 1 - (y / rect.height);
      const vol = Math.max(0, Math.min(1, pct));
      audioPlayer.volume = vol;
      lastVolume = vol > 0 ? vol : lastVolume;
      updateVolumeUI();
    }
    
    volumeSliderContainer.addEventListener('mousedown', (e) => {
      e.stopPropagation();
      volumeDragging = true;
      updateVolumeFromEvent(e);
    });
    
    volumeSliderContainer.addEventListener('touchstart', (e) => {
      e.stopPropagation();
      volumeDragging = true;
      updateVolumeFromEvent(e);
    });
    
    document.addEventListener('mousemove', (e) => {
      if (volumeDragging) updateVolumeFromEvent(e);
    });
    
    document.addEventListener('touchmove', (e) => {
      if (volumeDragging) updateVolumeFromEvent(e);
    });
    
    document.addEventListener('mouseup', () => { volumeDragging = false; });
    document.addEventListener('touchend', () => { volumeDragging = false; });
    
    function updateVolumeUI() {
      const v = audioPlayer.volume;
      volumeSliderFill.style.height = (v * 100) + '%';
      if (v === 0) volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>';
      else if (v < 0.5) volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/>';
      else volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/>';
    }
    
    // Player functions
    function buildUrl(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `https://media.capital.it/${year}/${month}/${day}/episodes/bertallot/bertallot_${year}${month}${day}_220000.mp3`;
    }
    
    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }
    
    function formatTime(sec) {
      if (isNaN(sec)) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }
    
    function updatePlayer() {
      const dateValue = datePicker.value;
      if (dateValue) {
        audioPlayer.src = buildUrl(dateValue);
        episodeDate.textContent = `Puntata del ${formatDate(dateValue)}`;
        dateDisplay.textContent = formatDate(dateValue);
        isPlaying = false;
        updatePlayButton(false);
        progressFill.style.width = '0%';
        currentTimeEl.textContent = '0:00';
        remainingTimeEl.textContent = '-0:00';
        errorMessage.classList.remove('show');
      }
    }
    
    function updatePlayButton(playing) {
      if (playing) playIcon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
      else playIcon.innerHTML = '<polygon points="6,4 20,12 6,20"/>';
    }
    
    function updateNavButtons() {
      const currentDate = new Date(datePicker.value);
      const todayDate = new Date();
      todayDate.setHours(0, 0, 0, 0);
      currentDate.setHours(0, 0, 0, 0);
      nextDay.disabled = currentDate >= todayDate;
    }
    
    function changeDay(delta) {
      const currentDate = new Date(datePicker.value);
      currentDate.setDate(currentDate.getDate() + delta);
      const newDateStr = currentDate.toISOString().split('T')[0];
      if (newDateStr <= datePicker.max) {
        datePicker.value = newDateStr;
        updatePlayer();
        updateMediaSessionMetadata();
        updateNavButtons();
      }
    }
    
    prevDay.addEventListener('click', () => changeDay(-1));
    nextDay.addEventListener('click', () => changeDay(1));
    
    // Progress bar
    let progressDragging = false;
    
    progressContainer.addEventListener('click', (e) => {
      const rect = progressContainer.getBoundingClientRect();
      const pct = (e.clientX - rect.left) / rect.width;
      if (audioPlayer.duration) audioPlayer.currentTime = pct * audioPlayer.duration;
    });
    
    progressContainer.addEventListener('mousedown', () => progressDragging = true);
    progressContainer.addEventListener('touchstart', () => progressDragging = true);
    document.addEventListener('mouseup', () => progressDragging = false);
    document.addEventListener('touchend', () => progressDragging = false);
    
    document.addEventListener('mousemove', (e) => {
      if (progressDragging && audioPlayer.duration) {
        const rect = progressContainer.getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        progressFill.style.width = (pct * 100) + '%';
        currentTimeEl.textContent = formatTime(pct * audioPlayer.duration);
        remainingTimeEl.textContent = '-' + formatTime((1 - pct) * audioPlayer.duration);
      }
    });
    
    document.addEventListener('mouseup', (e) => {
      if (progressDragging && audioPlayer.duration) {
        const rect = progressContainer.getBoundingClientRect();
        const pct = Math.max(0, Math.min(1, (e.clientX - rect.left) / rect.width));
        audioPlayer.currentTime = pct * audioPlayer.duration;
      }
      progressDragging = false;
    });
    
    // Audio events
    audioPlayer.addEventListener('error', () => handlePlaybackError());
    audioPlayer.addEventListener('loadeddata', () => { errorMessage.classList.remove('show'); hideConnectionStatus(); retryCount = 0; });
    audioPlayer.addEventListener('waiting', () => { if (isPlaying) showConnectionStatus('reconnecting', 'Buffering...'); });
    audioPlayer.addEventListener('playing', () => { hideConnectionStatus(); retryCount = 0; });
    
    audioPlayer.addEventListener('loadedmetadata', () => {
      remainingTimeEl.textContent = '-' + formatTime(audioPlayer.duration);
      if ('mediaSession' in navigator) {
        navigator.mediaSession.setPositionState({ duration: audioPlayer.duration, playbackRate: 1, position: 0 });
      }
    });
    
    audioPlayer.addEventListener('timeupdate', () => {
      if (!progressDragging) {
        const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
        progressFill.style.width = pct + '%';
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        remainingTimeEl.textContent = '-' + formatTime(audioPlayer.duration - audioPlayer.currentTime);
        if ('mediaSession' in navigator && audioPlayer.duration) {
          navigator.mediaSession.setPositionState({ duration: audioPlayer.duration, playbackRate: audioPlayer.playbackRate, position: audioPlayer.currentTime });
        }
      }
    });
    
    playBtn.addEventListener('click', () => {
      if (isPlaying) { audioPlayer.pause(); updatePlayButton(false); }
      else { audioPlayer.play(); updatePlayButton(true); }
      isPlaying = !isPlaying;
    });
    
    skipBack.addEventListener('click', () => audioPlayer.currentTime -= 30);
    skipForward.addEventListener('click', () => audioPlayer.currentTime += 30);
    
    // Connection handling
    function handlePlaybackError() {
      lastPlaybackTime = audioPlayer.currentTime || 0;
      wasPlayingBeforeError = isPlaying;
      updatePlayButton(false);
      isPlaying = false;
      pauseSleepTimer();
      
      if (!navigator.onLine) { handleOffline(); return; }
      
      fetch(audioPlayer.src, { method: 'HEAD' })
        .then(response => {
          if (response.status === 404) { errorMessage.classList.add('show'); hideConnectionStatus(); }
          else attemptReconnect();
        })
        .catch(() => attemptReconnect());
    }
    
    function attemptReconnect() {
      if (retryCount >= 5) {
        showConnectionStatus('offline', 'Connessione fallita. Tocca per riprovare.');
        connectionStatus.style.cursor = 'pointer';
        connectionStatus.onclick = () => { retryCount = 0; attemptReconnect(); };
        return;
      }
      
      retryCount++;
      const delay = Math.min(5000 * retryCount, 20000);
      showConnectionStatus('reconnecting', `Riconnessione... (${retryCount}/5)`);
      
      if (retryTimer) clearTimeout(retryTimer);
      retryTimer = setTimeout(() => {
        const currentSrc = audioPlayer.src;
        audioPlayer.src = '';
        audioPlayer.src = currentSrc;
        audioPlayer.currentTime = lastPlaybackTime;
        
        if (wasPlayingBeforeError) {
          audioPlayer.play()
            .then(() => { isPlaying = true; updatePlayButton(true); hideConnectionStatus(); retryCount = 0; resumeSleepTimer(); })
            .catch(() => attemptReconnect());
        }
      }, delay);
    }
    
    function handleOnline() {
      showConnectionStatus('online', 'Connessione ripristinata');
      setTimeout(() => {
        hideConnectionStatus();
        if (wasPlayingBeforeError && lastPlaybackTime > 0) { retryCount = 0; attemptReconnect(); }
      }, 1500);
    }
    
    function handleOffline() {
      showConnectionStatus('offline', 'Nessuna connessione internet');
      pauseSleepTimer();
      if (retryTimer) clearTimeout(retryTimer);
    }
    
    function showConnectionStatus(type, message) {
      connectionStatus.className = 'connection-status show ' + type;
      connectionText.textContent = message;
    }
    
    function hideConnectionStatus() {
      connectionStatus.classList.remove('show');
      connectionStatus.onclick = null;
    }
    
    window.addEventListener('online', handleOnline);
    window.addEventListener('offline', handleOffline);
    
    // PWA Install
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');
    const installClose = document.getElementById('installClose');
    
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installPrompt.classList.add('show'); });
    installBtn.addEventListener('click', async () => { if (deferredPrompt) { deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installPrompt.classList.remove('show'); } });
    installClose.addEventListener('click', () => installPrompt.classList.remove('show'));
    window.addEventListener('appinstalled', () => installPrompt.classList.remove('show'));
    
    // Media Session API
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: 'B-SIDE',
        artist: 'Alessio Bertallot',
        album: 'Radio Capital',
        artwork: [
          { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
          { src: 'icon-512.png', sizes: '512x512', type: 'image/png' }
        ]
      });
      
      navigator.mediaSession.setActionHandler('play', () => { audioPlayer.play(); updatePlayButton(true); isPlaying = true; });
      navigator.mediaSession.setActionHandler('pause', () => { audioPlayer.pause(); updatePlayButton(false); isPlaying = false; });
      navigator.mediaSession.setActionHandler('seekbackward', () => audioPlayer.currentTime -= 30);
      navigator.mediaSession.setActionHandler('seekforward', () => audioPlayer.currentTime += 30);
      navigator.mediaSession.setActionHandler('seekto', (d) => { if (d.seekTime) audioPlayer.currentTime = d.seekTime; });
    }
    
    function updateMediaSessionMetadata() {
      if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: `Puntata del ${formatDate(datePicker.value)}`,
          artist: 'Alessio Bertallot',
          album: 'B-SIDE - Radio Capital',
          artwork: [
            { src: 'icon-192.png', sizes: '192x192', type: 'image/png' },
            { src: 'icon-512.png', sizes: '512x512', type: 'image/png' }
          ]
        });
      }
    }
    
    // Init
    updateVolumeUI();
    updatePlayer();
    updateMediaSessionMetadata();
    updateNavButtons();
    
    // Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then((reg) => console.log('Service Worker registrato:', reg.scope))
        .catch((err) => console.log('Service Worker errore:', err));
    }
  </script>
</body>
</html>
