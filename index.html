<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#f0f2f5" id="themeColor">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="B-SIDE">
  <title>B-SIDE</title>
  
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
  <link rel="apple-touch-icon" href="icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-gradient: linear-gradient(135deg, #f0f2f5 0%, #e8eaed 50%, #d8dce3 100%);
      --glass-bg: rgba(255, 255, 255, 0.4);
      --glass-bg-solid: rgba(255, 255, 255, 0.6);
      --glass-border: rgba(255, 255, 255, 0.6);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      --text: #1a1a2e;
      --text-secondary: rgba(26, 26, 46, 0.6);
      --accent: #1a1a2e;
      --blur: 20px;
      --play-btn-bg: #1a1a2e;
      --play-btn-color: #ffffff;
    }
    
    [data-theme="dark"] {
      --bg-gradient: linear-gradient(135deg, #0a0a12 0%, #12121f 50%, #1a1a2e 100%);
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-bg-solid: rgba(255, 255, 255, 0.12);
      --glass-border: rgba(255, 255, 255, 0.12);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      --text: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      --accent: #ffffff;
      --play-btn-bg: #ffffff;
      --play-btn-color: #1a1a2e;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg-gradient);
      background-attachment: fixed;
      color: var(--text);
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
    }
    
    .app {
      height: calc(100% - 20px);
      max-width: 430px;
      margin: 10px auto;
      display: flex;
      flex-direction: column;
      padding: 15px;
      padding-bottom: 15px;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      border-radius: 30px;
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }

    @media (max-width: 375px) {
      .app {
        padding: 12px;
        margin: 8px auto;
        height: calc(100% - 16px);
      }
    }
    
    /* === GLASS BUTTON BASE === */
    .glass-btn {
      background: var(--glass-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
      transition: all 0.3s ease;
    }
    
    .glass-btn:hover {
      background: var(--glass-bg-solid);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }
    
    .glass-btn:active {
      transform: translateY(0);
      background: var(--glass-bg);
    }
    
    [data-theme="dark"] .glass-btn:hover {
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }
    
    /* === DEBUG CONSOLE === */
    .debug-console {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 180px;
      background: rgba(0, 0, 0, 0.95);
      color: #0f0;
      font-family: monospace;
      font-size: 10px;
      padding: 5px;
      overflow-y: auto;
      z-index: 9999;
      display: none;
    }
    .debug-console.show { display: block; }
    .debug-line { margin: 1px 0; }
    .debug-line.error { color: #f55; }
    .debug-line.warn { color: #fa0; }
    .debug-line.success { color: #5f5; }
    .debug-line.network { color: #5ff; }
    .debug-toggle {
      position: fixed;
      top: 5px;
      right: 5px;
      width: 30px;
      height: 30px;
      background: #333;
      color: #0f0;
      border: none;
      border-radius: 5px;
      font-size: 12px;
      z-index: 10000;
      cursor: pointer;
    }
    .debug-console.show ~ .debug-toggle { top: 185px; }
    
    /* === TOP BAR === */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 5px;
      margin-bottom: 20px;
    }
    
    .icon-btn {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }
    .icon-btn svg { width: 20px; height: 20px; }
    
    /* === DATE PICKER === */
    .date-picker-btn {
      border: none;
      border-radius: 14px;
      padding: 10px 16px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }
    .date-picker-btn span { font-size: 0.9rem; font-weight: 600; color: var(--text); }
    .date-picker-btn svg { color: var(--text-secondary); width: 18px; height: 18px; }
    .date-picker-btn input {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      opacity: 0;
      cursor: pointer;
    }
    
    /* === ARTWORK === */
    .artwork-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px 0;
    }
    .artwork {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
    }
    .artwork h1 { 
      font-size: 3.5rem; 
      font-weight: 800; 
      letter-spacing: -2px; 
      color: var(--text);
      margin-bottom: 8px; 
    }
    .artwork p { 
      font-size: 1rem; 
      font-weight: 400; 
      color: var(--text-secondary);
    }
    
    /* === TRACK INFO === */
    .track-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 10px;
    }
    .track-details h2 { font-size: 1.4rem; font-weight: 700; color: var(--text); margin-bottom: 4px; }
    .track-details p { font-size: 0.9rem; color: var(--text-secondary); }
    
    /* === FAVORITE BUTTON === */
    .fav-btn {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      -webkit-tap-highlight-color: transparent;
    }
    .fav-btn.active { color: #e74c3c; }
    .fav-btn.active svg { fill: #e74c3c; }
    .fav-btn svg { width: 22px; height: 22px; }
    
    /* === PROGRESS BAR === */
    .progress-section { padding: 10px 10px 20px; }
    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--glass-bg-solid);
      border-radius: 3px;
      position: relative;
      cursor: pointer;
      touch-action: none;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 3px;
      width: 0%;
      position: relative;
      transition: width 0.1s linear;
    }
    .progress-thumb {
      position: absolute;
      right: -8px;
      top: 50%;
      transform: translateY(-50%);
      width: 16px;
      height: 16px;
      background: var(--accent);
      border-radius: 50%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .buffer-bar {
      position: absolute;
      top: 0; left: 0;
      height: 100%;
      background: var(--text-secondary);
      opacity: 0.3;
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s;
    }
    .time-display {
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      font-variant-numeric: tabular-nums;
    }
    
    /* === STATUS MESSAGE === */
    .status-message {
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-top: 5px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .status-message.show { opacity: 1; }
    .status-message.error { color: #e74c3c; }
    .status-message.warning { color: #f39c12; }
    .status-message.success { color: #27ae60; }
    .status-message .network-badge {
      font-size: 0.65rem;
      padding: 2px 6px;
      background: var(--glass-bg-solid);
      border-radius: 4px;
      opacity: 0.8;
    }
    .status-spinner {
      display: inline-block;
      width: 12px; height: 12px;
      border: 2px solid currentColor;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* === CONTROLS === */
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      padding: 15px 0 25px;
    }
    .ctrl-btn {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text);
      font-family: 'Inter', sans-serif;
      font-size: 0.85rem;
      font-weight: 600;
      -webkit-tap-highlight-color: transparent;
    }
    .ctrl-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .ctrl-btn svg { width: 18px; height: 18px; }
    
    .play-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--play-btn-bg);
      border: none;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      color: var(--play-btn-color);
    }
    .play-btn:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 15px 50px rgba(0,0,0,0.25);
    }
    .play-btn:active { transform: translateY(0) scale(0.98); }
    .play-btn svg { width: 28px; height: 28px; fill: currentColor; }

    /* === BOTTOM NAV === */
    .bottom-nav {
      padding: 15px 30px 10px;
      display: flex;
      justify-content: space-around;
      align-items: center;
    }

    .nav-item {
      width: 50px;
      height: 50px;
      border: none;
      border-radius: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-family: 'Inter', sans-serif;
      font-size: 0.7rem;
      font-weight: 600;
      gap: 2px;
      -webkit-tap-highlight-color: transparent;
    }
    .nav-item.active { color: var(--accent); }
    .nav-item svg { width: 22px; height: 22px; }
    .sleep-countdown { font-size: 0.75rem; font-weight: 700; color: var(--accent); }
    
    /* === NETWORK INDICATOR === */
    .network-indicator {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      display: none;
      align-items: center;
      gap: 6px;
      z-index: 1000;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    .network-indicator.show { display: flex; }
    .network-indicator.offline { background: rgba(231,76,60,0.9); color: white; }
    .network-indicator.slow { background: rgba(243,156,18,0.9); color: white; }
    .network-indicator.online { background: rgba(39,174,96,0.9); color: white; }
    
    /* === POPUPS === */
    .popup-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(5px);
      -webkit-backdrop-filter: blur(5px);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .popup-overlay.show { display: flex; }
    
    .volume-popup, .sleep-menu, .favorites-popup {
      background: var(--glass-bg-solid);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      box-shadow: var(--glass-shadow);
    }
    
    .volume-popup {
      border-radius: 24px;
      padding: 30px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }
    .volume-slider {
      width: 8px;
      height: 150px;
      background: var(--glass-bg);
      border-radius: 4px;
      position: relative;
      cursor: pointer;
      touch-action: none;
    }
    .volume-fill {
      position: absolute;
      bottom: 0;
      width: 100%;
      background: var(--accent);
      border-radius: 4px;
    }
    .volume-fill .progress-thumb { top: -8px; right: 50%; transform: translateX(50%); }
    .popup-title { font-size: 0.9rem; font-weight: 600; color: var(--text); }
    
    .sleep-menu {
      border-radius: 20px;
      padding: 20px;
    }
    .sleep-option {
      padding: 15px 40px;
      border-radius: 12px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      margin-bottom: 10px;
      text-align: center;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text);
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .sleep-option:last-child { margin-bottom: 0; }
    .sleep-option:hover {
      background: var(--glass-bg-solid);
      transform: translateY(-2px);
    }
    .sleep-option:active, .sleep-option.selected { 
      background: var(--glass-bg-solid);
      color: var(--accent);
      transform: translateY(0);
    }
    
    .favorites-popup {
      border-radius: 20px;
      padding: 20px;
      max-width: 300px;
      width: 90%;
    }
    .favorites-header { font-size: 1rem; font-weight: 700; color: var(--text); margin-bottom: 15px; text-align: center; }
    .favorites-list { max-height: 250px; overflow-y: auto; }
    .fav-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 8px;
      border-radius: 12px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      transition: all 0.2s;
      -webkit-tap-highlight-color: transparent;
    }
    .fav-item:hover {
      background: var(--glass-bg-solid);
      transform: translateY(-2px);
    }
    .fav-item:active { 
      background: var(--glass-bg-solid);
      transform: translateY(0);
    }
    .fav-item-del { background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 5px; }
    .fav-item-del:hover { color: #e74c3c; }
    .fav-item-del svg { width: 16px; height: 16px; }
    .favorites-empty { text-align: center; color: var(--text-secondary); font-size: 0.9rem; padding: 20px; }
    
    /* === INSTALL PROMPT === */
    .install-prompt {
      display: none;
      position: fixed;
      bottom: 100px;
      left: 20px; right: 20px;
      background: var(--glass-bg-solid);
      backdrop-filter: blur(25px);
      -webkit-backdrop-filter: blur(25px);
      border: 1px solid var(--glass-border);
      color: var(--text);
      padding: 20px;
      border-radius: 20px;
      text-align: center;
      box-shadow: var(--glass-shadow);
      z-index: 1000;
    }
    .install-prompt.show { display: block; }
    .install-prompt p { margin-bottom: 16px; font-size: 0.95rem; font-weight: 500; }
    .install-btn {
      background: var(--accent);
      color: var(--play-btn-color);
      border: none;
      padding: 12px 28px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      margin-right: 10px;
      transition: all 0.3s ease;
    }
    .install-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    }
    .install-close {
      background: var(--glass-bg);
      color: var(--text);
      border: 1px solid var(--glass-border);
      padding: 12px 20px;
      border-radius: 50px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .install-close:hover {
      background: var(--glass-bg-solid);
      transform: translateY(-2px);
    }
    
    audio { display: none; }
  </style>
</head>

<body>
  <!-- DEBUG CONSOLE -->
  <div class="debug-console" id="debugConsole"></div>
  <button class="debug-toggle" id="debugToggle">ðŸ”§</button>
  
  <!-- NETWORK INDICATOR -->
  <div class="network-indicator" id="networkIndicator">
    <span id="networkIcon">ðŸ“¶</span>
    <span id="networkText">Online</span>
  </div>

  <div class="app">
    <!-- TOP BAR -->
    <div class="top-bar">
      <div class="date-picker-btn glass-btn" id="datePickerBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <span id="dateDisplay">--/--/----</span>
        <input type="date" id="datePicker">
      </div>
      <button class="icon-btn glass-btn" id="menuBtn">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <circle cx="12" cy="5" r="2"/>
          <circle cx="12" cy="12" r="2"/>
          <circle cx="12" cy="19" r="2"/>
        </svg>
      </button>
    </div>

    <!-- ARTWORK -->
    <div class="artwork-container">
      <div class="artwork">
        <h1>B-SIDE</h1>
        <p>Alessio Bertallot</p>
      </div>
    </div>

    <!-- TRACK INFO -->
    <div class="track-info">
      <div class="track-details">
        <h2 id="episodeDate">--/--/----</h2>
        <p>Radio Capital</p>
      </div>
      <button class="fav-btn glass-btn" id="favBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
        </svg>
      </button>
    </div>

    <!-- PROGRESS SECTION -->
    <div class="progress-section">
      <div class="progress-bar" id="progressBar">
        <div class="buffer-bar" id="bufferBar"></div>
        <div class="progress-fill" id="progressFill">
          <div class="progress-thumb"></div>
        </div>
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="remainingTime">-0:00</span>
      </div>
      <div class="status-message" id="statusMessage">
        <span id="statusText"></span>
      </div>
    </div>

    <!-- CONTROLS -->
    <div class="controls">
      <button class="ctrl-btn glass-btn" id="prevDay">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
        </svg>
      </button>
      <button class="ctrl-btn glass-btn" id="skipBack">-30</button>
      <button class="ctrl-btn play-btn" id="playBtn">
        <svg viewBox="0 0 24 24" id="playIcon">
          <polygon points="6,4 20,12 6,20"/>
        </svg>
      </button>
      <button class="ctrl-btn glass-btn" id="skipForward">+30</button>
      <button class="ctrl-btn glass-btn" id="nextDay">
        <svg viewBox="0 0 24 24" fill="currentColor">
          <path d="M16 6h2v12h-2zM6 18l8.5-6L6 6z"/>
        </svg>
      </button>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav">
      <button class="nav-item glass-btn" id="sleepBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="sleepIcon">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
        <span class="sleep-countdown" id="sleepCountdown" style="display:none;"></span>
      </button>
      <button class="nav-item glass-btn" id="volumeNavBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="volumeIcon">
          <path d="M11 5L6 9H2v6h4l5 4V5z"/>
          <path d="M15.54 8.46a5 5 0 010 7.07"/>
          <path d="M19.07 4.93a10 10 0 010 14.14"/>
        </svg>
      </button>
      <button class="nav-item glass-btn" id="themeBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="themeIcon">
          <circle cx="12" cy="12" r="5"/>
          <line x1="12" y1="1" x2="12" y2="3"/>
          <line x1="12" y1="21" x2="12" y2="23"/>
          <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
          <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
          <line x1="1" y1="12" x2="3" y2="12"/>
          <line x1="21" y1="12" x2="23" y2="12"/>
          <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
          <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
        </svg>
      </button>
    </div>
  </div>
  
  <!-- POPUP OVERLAYS -->
  <div class="popup-overlay" id="volumeOverlay">
    <div class="volume-popup">
      <span class="popup-title">Volume</span>
      <div class="volume-slider" id="volumeSlider">
        <div class="volume-fill" id="volumeFill" style="height:100%;">
          <div class="progress-thumb"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="popup-overlay" id="sleepOverlay">
    <div class="sleep-menu">
      <div class="sleep-option" data-min="15">15 min</div>
      <div class="sleep-option" data-min="30">30 min</div>
      <div class="sleep-option" data-min="60">60 min</div>
      <div class="sleep-option" data-min="90">90 min</div>
      <div class="sleep-option" data-min="0">Off</div>
    </div>
  </div>

  <div class="popup-overlay" id="favOverlay">
    <div class="favorites-popup">
      <div class="favorites-header">Preferiti</div>
      <div class="favorites-list" id="favList"></div>
    </div>
  </div>

  <div class="install-prompt" id="installPrompt">
    <p>Installa B-SIDE sulla tua home screen</p>
    <button class="install-btn" id="installBtn">Installa</button>
    <button class="install-close" id="installClose">No grazie</button>
  </div>
  
  <audio id="audio" preload="auto"></audio>

  <script>
// ============================================
// DEBUG SYSTEM
// ============================================
var DEBUG_ENABLED = true;
var debugConsole = document.getElementById('debugConsole');
var debugToggle = document.getElementById('debugToggle');
var debugLogs = [];
var MAX_LOGS = 150;

debugToggle.onclick = function() { debugConsole.classList.toggle('show'); };

function log(msg, type) {
  if (!DEBUG_ENABLED) return;
  type = type || 'info';
  var t = new Date();
  var ts = t.toLocaleTimeString('it-IT') + '.' + String(t.getMilliseconds()).padStart(3, '0');
  var line = '[' + ts + '] ' + msg;
  debugLogs.push({ t: line, y: type });
  if (debugLogs.length > MAX_LOGS) debugLogs.shift();
  var h = '';
  for (var i = 0; i < debugLogs.length; i++) {
    h += '<div class="debug-line ' + debugLogs[i].y + '">' + debugLogs[i].t + '</div>';
  }
  debugConsole.innerHTML = h;
  debugConsole.scrollTop = debugConsole.scrollHeight;
  console.log('[' + type.toUpperCase() + ']', msg);
}

// ============================================
// STREAMING ENGINE - STATO CENTRALIZZATO
// ============================================
var Engine = {
  audio: null,
  currentUrl: '',
  position: { current: 0, lastSaved: 0, saveInterval: null },
  buffer: { ahead: 0, minHealthy: 10, isHealthy: false, percent: 0 },
  network: { isOnline: navigator.onLine, type: null, downlink: null, rtt: null, saveData: false, quality: 100 },
  recovery: {
    isActive: false, startTime: null, attempt: 0, maxAttempts: 35, strategy: 'seek',
    timer: null, watchdog: null, watchdogTimeout: 20000, scheduledAt: null, expectedDelay: null,
    lastEventTime: 0, lastRecoveryTime: 0, minEventInterval: 2000, eventDrivenEnabled: true
  },
  intent: { shouldBePlaying: false, pausedByUser: false, pausedBySystem: false },
  lifecycle: { isVisible: true, isActive: true, lastActiveTime: Date.now() }
};

// ============================================
// DOM ELEMENTS
// ============================================
var audio = document.getElementById('audio');
var datePicker = document.getElementById('datePicker');
var datePickerBtn = document.getElementById('datePickerBtn');
var dateDisplay = document.getElementById('dateDisplay');
var episodeDate = document.getElementById('episodeDate');
var progressBar = document.getElementById('progressBar');
var progressFill = document.getElementById('progressFill');
var bufferBar = document.getElementById('bufferBar');
var currentTimeEl = document.getElementById('currentTime');
var remainingTime = document.getElementById('remainingTime');
var playBtn = document.getElementById('playBtn');
var playIcon = document.getElementById('playIcon');
var prevDay = document.getElementById('prevDay');
var nextDay = document.getElementById('nextDay');
var skipBack = document.getElementById('skipBack');
var skipForward = document.getElementById('skipForward');
var favBtn = document.getElementById('favBtn');
var sleepBtn = document.getElementById('sleepBtn');
var sleepIcon = document.getElementById('sleepIcon');
var sleepCountdown = document.getElementById('sleepCountdown');
var volumeNavBtn = document.getElementById('volumeNavBtn');
var volumeIcon = document.getElementById('volumeIcon');
var themeBtn = document.getElementById('themeBtn');
var themeIcon = document.getElementById('themeIcon');
var volumeOverlay = document.getElementById('volumeOverlay');
var volumeSlider = document.getElementById('volumeSlider');
var volumeFill = document.getElementById('volumeFill');
var sleepOverlay = document.getElementById('sleepOverlay');
var favOverlay = document.getElementById('favOverlay');
var favList = document.getElementById('favList');
var menuBtn = document.getElementById('menuBtn');
var statusMessage = document.getElementById('statusMessage');
var statusText = document.getElementById('statusText');
var themeColorMeta = document.getElementById('themeColor');
var networkIndicator = document.getElementById('networkIndicator');
var networkIcon = document.getElementById('networkIcon');
var networkText = document.getElementById('networkText');

var isPlaying = false;
var sleepTimer = null;
var sleepEndTime = null;
var sleepInterval = null;
var favorites = JSON.parse(localStorage.getItem('bside-fav') || '[]');
var deferredPrompt = null;
var progressDragging = false;
var seekTime = 0;
var volDrag = false;

Engine.audio = audio;

// ============================================
// UTILITY FUNCTIONS
// ============================================
function formatTime(s) {
  if (isNaN(s) || s < 0) return '0:00';
  var m = Math.floor(s / 60);
  var sec = Math.floor(s % 60);
  return m + ':' + (sec < 10 ? '0' : '') + sec;
}

function formatDate(d) {
  var p = d.split('-');
  return p[2] + '/' + p[1] + '/' + p[0];
}

function buildUrl(d) {
  var p = d.split('-');
  return 'https://media.capital.it/' + p[0] + '/' + p[1] + '/' + p[2] + '/episodes/bertallot/bertallot_' + p[0] + p[1] + p[2] + '_220000.mp3';
}

function updatePlayIcon(playing) {
  playIcon.innerHTML = playing 
  ? '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>' 
  : '<polygon points="6,4 20,12 6,20"/>';
}

// ============================================
// STATUS & UI
// ============================================
function showStatus(msg, type, spin) {
  var html = '';
  if (spin) html += '<span class="status-spinner"></span> ';
  html += msg;
  if ((type === 'warning' || type === 'error') && Engine.network.type) {
    html += ' <span class="network-badge">' + Engine.network.type.toUpperCase() + '</span>';
  }
  statusText.innerHTML = html;
  statusMessage.className = 'status-message show ' + (type || '');
}

function hideStatus() { statusMessage.classList.remove('show'); }

function showNetworkIndicator(type, text) {
  networkIndicator.className = 'network-indicator show ' + type;
  networkText.textContent = text;
  networkIcon.textContent = type === 'offline' ? 'ðŸ“µ' : (type === 'slow' ? 'ðŸ“¶' : 'âœ”');
  if (type === 'online') setTimeout(function() { networkIndicator.classList.remove('show'); }, 2000);
}

function hideNetworkIndicator() { networkIndicator.classList.remove('show'); }

// ============================================
// NETWORK MONITORING
// ============================================
function initNetworkMonitoring() {
  updateNetworkInfo();
  window.addEventListener('online', handleOnline);
  window.addEventListener('offline', handleOffline);
  if ('connection' in navigator) {
    navigator.connection.addEventListener('change', function() {
      var oldQuality = Engine.network.quality;
      updateNetworkInfo();
      if (Engine.intent.shouldBePlaying && Engine.network.quality > oldQuality) {
        Engine.recovery.attempt = Math.max(0, Engine.recovery.attempt - 2);
        clearRecoveryTimers();
        if (!isPlaying) setTimeout(function() { if (Engine.intent.shouldBePlaying && !isPlaying) executeRecovery(); }, 800);
      }
    });
  }
}

function updateNetworkInfo() {
  var conn = navigator.connection || navigator.mozConnection || navigator.webkitConnection;
  Engine.network.isOnline = navigator.onLine;
  if (conn) { Engine.network.type = conn.effectiveType; Engine.network.downlink = conn.downlink; Engine.network.rtt = conn.rtt; Engine.network.saveData = conn.saveData; }
  Engine.network.quality = calculateNetworkQuality();
}

function calculateNetworkQuality() {
  if (!navigator.onLine) return 0;
  var type = Engine.network.type, downlink = Engine.network.downlink, rtt = Engine.network.rtt, quality = 100;
  if (type === 'slow-2g') quality = 10; else if (type === '2g') quality = 30; else if (type === '3g') quality = 60; else if (type === '4g') quality = 90;
  if (downlink !== null && downlink !== undefined) { if (downlink < 0.5) quality = Math.min(quality, 20); else if (downlink < 1) quality = Math.min(quality, 40); else if (downlink < 2) quality = Math.min(quality, 60); }
  if (rtt !== null && rtt !== undefined) { if (rtt > 500) quality = Math.min(quality, 30); else if (rtt > 300) quality = Math.min(quality, 50); }
  return quality;
}

function handleOnline() {
  Engine.network.isOnline = true; updateNetworkInfo(); showNetworkIndicator('online', 'Connesso');
  if (Engine.intent.shouldBePlaying && !isPlaying) { Engine.recovery.attempt = 0; clearRecoveryTimers(); setTimeout(function() { if (Engine.intent.shouldBePlaying && !isPlaying) executeRecovery(); }, 500); }
}

function handleOffline() {
  Engine.network.isOnline = false; Engine.network.quality = 0; showNetworkIndicator('offline', 'Offline');
  if (isPlaying || Engine.intent.shouldBePlaying) { Engine.intent.shouldBePlaying = true; Engine.position.current = audio.currentTime || Engine.position.current; savePositionToStorage(); }
  showStatus('Offline - in attesa di connessione...', 'error');
}

// ============================================
// BUFFER & POSITION
// ============================================
function updateBufferHealth() {
  var buffered = audio.buffered, currentTime = audio.currentTime, duration = audio.duration, ahead = 0;
  for (var i = 0; i < buffered.length; i++) { if (buffered.start(i) <= currentTime && buffered.end(i) > currentTime) { ahead = buffered.end(i) - currentTime; break; } }
  Engine.buffer.ahead = ahead; Engine.buffer.minHealthy = Engine.network.quality < 30 ? 20 : (Engine.network.quality < 60 ? 15 : 10);
  Engine.buffer.isHealthy = ahead >= Engine.buffer.minHealthy;
  if (duration > 0) { var bufferEnd = 0; for (var j = 0; j < buffered.length; j++) { if (buffered.end(j) > bufferEnd) bufferEnd = buffered.end(j); } Engine.buffer.percent = (bufferEnd / duration) * 100; bufferBar.style.width = Engine.buffer.percent + '%'; }
}

function initPositionTracking() {
  Engine.position.saveInterval = setInterval(function() { if (Engine.position.current > 0 && Math.abs(Engine.position.current - Engine.position.lastSaved) > 5) savePositionToStorage(); }, 15000);
  window.addEventListener('beforeunload', savePositionToStorage);
  document.addEventListener('visibilitychange', function() { if (document.visibilityState === 'hidden') savePositionToStorage(); });
}

function savePositionToStorage() {
  if (Engine.position.current <= 0) return;
  try { localStorage.setItem('bside-pos-' + datePicker.value, JSON.stringify({ position: Engine.position.current, duration: audio.duration || 0, timestamp: Date.now() })); Engine.position.lastSaved = Engine.position.current; } catch (e) {}
}

function loadPositionFromStorage() {
  try { var saved = localStorage.getItem('bside-pos-' + datePicker.value); if (saved) { var data = JSON.parse(saved); if (Date.now() - data.timestamp < 7 * 24 * 60 * 60 * 1000) { Engine.position.current = data.position; Engine.position.lastSaved = data.position; return data.position; } } } catch (e) {}
  return 0;
}

// ============================================
// RECOVERY SYSTEM
// ============================================
function clearRecoveryTimers() { if (Engine.recovery.timer) { clearTimeout(Engine.recovery.timer); Engine.recovery.timer = null; } if (Engine.recovery.watchdog) { clearTimeout(Engine.recovery.watchdog); Engine.recovery.watchdog = null; } }

function triggerEventDrivenRecovery(eventType) {
  if (!Engine.recovery.eventDrivenEnabled || !Engine.intent.shouldBePlaying || Engine.intent.pausedByUser) return false;
  var now = Date.now(), timeSinceLastRecovery = now - Engine.recovery.lastRecoveryTime, minInterval = Engine.recovery.minEventInterval;
  if (Engine.recovery.attempt > 3) minInterval = Math.min(minInterval * Math.pow(1.3, Engine.recovery.attempt - 3), 10000);
  if (timeSinceLastRecovery < minInterval || now - Engine.recovery.lastEventTime < 500) return false;
  Engine.recovery.lastEventTime = now;
  if (!Engine.lifecycle.isVisible) { executeEventDrivenRecovery(eventType); return true; }
  return false;
}

function executeEventDrivenRecovery(eventType) {
  if (!navigator.onLine || (!audio.paused && audio.readyState >= 3)) return;
  Engine.recovery.attempt++; Engine.recovery.lastRecoveryTime = Date.now();
  if (Engine.recovery.attempt >= Engine.recovery.maxAttempts) return;
  selectRecoveryStrategy();
  var targetTime = Engine.position.current;
  if (Engine.recovery.strategy === 'seek') { try { if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) audio.currentTime = targetTime; audio.play().then(onRecoverySuccess).catch(function(){}); } catch(e){} }
  else if (Engine.recovery.strategy === 'reload') audio.load();
  else { audio.src = Engine.currentUrl + (Engine.currentUrl.includes('?') ? '&' : '?') + '_t=' + Date.now(); audio.load(); }
}

function setRecoveryWatchdog() { clearTimeout(Engine.recovery.watchdog); Engine.recovery.watchdog = setTimeout(function() { if (Engine.recovery.isActive) { Engine.recovery.isActive = false; startRecovery(); } }, Engine.recovery.strategy === 'refetch' ? 20000 : Engine.recovery.watchdogTimeout); }

function startRecovery() {
  if (Engine.intent.pausedByUser || !Engine.intent.shouldBePlaying) return;
  if (Engine.recovery.isActive && Engine.recovery.startTime && Date.now() - Engine.recovery.startTime < 2000) return;
  if (Engine.recovery.attempt >= Engine.recovery.maxAttempts) { showStatus('Connessione persa. Tocca Play per riprovare.', 'error'); Engine.intent.shouldBePlaying = false; Engine.recovery.isActive = false; clearRecoveryTimers(); return; }
  Engine.recovery.isActive = true; Engine.recovery.startTime = Date.now(); Engine.recovery.attempt++;
  var delay = calculateRecoveryDelay();
  showStatus('Riconnessione (' + Engine.recovery.attempt + ')...', 'warning', true);
  clearRecoveryTimers(); setRecoveryWatchdog();
  Engine.recovery.scheduledAt = Date.now(); Engine.recovery.expectedDelay = delay;
  Engine.recovery.timer = setTimeout(executeRecovery, delay);
}

function calculateRecoveryDelay() {
  var attempt = Engine.recovery.attempt, quality = Engine.network.quality, baseDelay;
  if (attempt <= 3) baseDelay = 800 + (200 * attempt);
  else if (attempt <= 10) baseDelay = 1500 * Math.pow(1.3, attempt - 3);
  else baseDelay = 5000 + (attempt - 10) * 800;
  if (quality === 0) baseDelay = Math.max(baseDelay, 3000);
  else if (quality < 30) baseDelay *= 1.4;
  return Math.min(baseDelay, 12000);
}

function selectRecoveryStrategy() { var attempt = Engine.recovery.attempt; if (attempt <= 2 && audio.readyState >= 2) Engine.recovery.strategy = 'seek'; else if (attempt <= 6) Engine.recovery.strategy = 'reload'; else Engine.recovery.strategy = 'refetch'; }

function executeRecovery() {
  if (!navigator.onLine) { showStatus('Offline, attendo connessione...', 'error'); Engine.recovery.timer = setTimeout(startRecovery, 3000); return; }
  selectRecoveryStrategy();
  if (Engine.recovery.strategy === 'seek') executeSeekStrategy();
  else if (Engine.recovery.strategy === 'reload') executeReloadStrategy();
  else executeRefetchStrategy();
}

function executeSeekStrategy() {
  try { if (Engine.position.current > 0 && audio.duration && Engine.position.current < audio.duration - 1) audio.currentTime = Engine.position.current; attemptPlay(); }
  catch (e) { Engine.recovery.strategy = 'reload'; setTimeout(executeRecovery, 500); }
}

function executeReloadStrategy() {
  var targetTime = Engine.position.current; audio.pause(); audio.load();
  var loadTimeout = setTimeout(onLoadError, 15000);
  function onCanPlay() { clearTimeout(loadTimeout); audio.removeEventListener('canplay', onCanPlay); audio.removeEventListener('error', onLoadError); if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) audio.currentTime = targetTime; attemptPlay(); }
  function onLoadError() { clearTimeout(loadTimeout); audio.removeEventListener('canplay', onCanPlay); audio.removeEventListener('error', onLoadError); setTimeout(startRecovery, 1000); }
  audio.addEventListener('canplay', onCanPlay); audio.addEventListener('error', onLoadError);
}

function executeRefetchStrategy() {
  var targetTime = Engine.position.current; audio.pause(); audio.src = Engine.currentUrl + (Engine.currentUrl.includes('?') ? '&' : '?') + '_t=' + Date.now();
  var loadTimeout = setTimeout(onLoadError, 20000);
  function onCanPlay() { clearTimeout(loadTimeout); audio.removeEventListener('canplay', onCanPlay); audio.removeEventListener('error', onLoadError); if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) audio.currentTime = targetTime; attemptPlay(); }
  function onLoadError() { clearTimeout(loadTimeout); audio.removeEventListener('canplay', onCanPlay); audio.removeEventListener('error', onLoadError); setTimeout(startRecovery, 1000); }
  audio.addEventListener('canplay', onCanPlay); audio.addEventListener('error', onLoadError); audio.load();
}

function attemptPlay() {
  var playPromise = audio.play();
  if (playPromise) playPromise.then(function() { onRecoverySuccess(); }).catch(function(err) {
    if (err.name === 'NotAllowedError') { showStatus('Tocca Play per riprendere', 'warning'); Engine.recovery.isActive = false; Engine.intent.pausedBySystem = true; clearRecoveryTimers(); }
    else if (err.name !== 'AbortError') setTimeout(startRecovery, 1000);
  });
}

function onRecoverySuccess() {
  Engine.recovery.isActive = false; 
  Engine.recovery.attempt = 0; 
  Engine.recovery.startTime = null; 
  Engine.recovery.strategy = 'seek'; 
  Engine.recovery.lastRecoveryTime = Date.now(); 
  Engine.intent.pausedBySystem = false;
  clearRecoveryTimers(); 
  hideStatus(); 
  hideNetworkIndicator();
}

</script>
<script>
// ============================================
// LIFECYCLE MANAGEMENT
// ============================================

function initLifecycleManagement() {
  document.addEventListener('visibilitychange', function() { Engine.lifecycle.isVisible = document.visibilityState === 'visible'; if (Engine.lifecycle.isVisible) onAppVisible(); else onAppHidden(); });
  window.addEventListener('focus', function() { Engine.lifecycle.isActive = true; Engine.lifecycle.lastActiveTime = Date.now(); onAppVisible(); });
  window.addEventListener('blur', function() { Engine.lifecycle.isActive = false; });
  window.addEventListener('pageshow', onAppVisible);
  audio.addEventListener('pause', function() { if (!Engine.intent.pausedByUser && Engine.intent.shouldBePlaying) Engine.intent.pausedBySystem = true; });
}

function onAppVisible() {
  var hiddenDuration = Math.round((Date.now() - Engine.lifecycle.lastActiveTime) / 1000); updateNetworkInfo();
  if (Engine.intent.shouldBePlaying && audio.paused && !Engine.recovery.isActive) { if (hiddenDuration > 30) Engine.recovery.attempt = 0; startRecovery(); }
  if (audio.currentTime > 0 && Math.abs(audio.currentTime - Engine.position.current) > 2) Engine.position.current = audio.currentTime;
}

function onAppHidden() { savePositionToStorage(); Engine.lifecycle.lastActiveTime = Date.now(); }

// ============================================
// AUDIO EVENTS
// ============================================
function initAudioEvents() {
  audio.addEventListener('loadedmetadata', function() { remainingTime.textContent = '-' + formatTime(audio.duration); });

  audio.addEventListener('canplay', function() {
    if (Engine.intent.shouldBePlaying && audio.paused) {
      if (Engine.position.current > 0 && audio.duration && Engine.position.current < audio.duration - 1) audio.currentTime = Engine.position.current;
      audio.play().then(onRecoverySuccess).catch(function(){});
    }
  });

  audio.addEventListener('stalled', function() { if (!Engine.intent.shouldBePlaying) return; showStatus('Connessione lenta...', 'warning', true); if (triggerEventDrivenRecovery('stalled')) return; setTimeout(function() { if (Engine.intent.shouldBePlaying && (audio.paused || audio.readyState < 3)) startRecovery(); }, 4000); });
  
  audio.addEventListener('pause', function() { isPlaying = false; updatePlayIcon(false); });
  
  audio.addEventListener('ended', function() { isPlaying = false; Engine.intent.shouldBePlaying = false; Engine.position.current = 0; updatePlayIcon(false); clearRecoveryTimers(); });
  
  audio.addEventListener('waiting', function() { if (!Engine.intent.shouldBePlaying) return; showStatus('Buffering... (' + Engine.buffer.ahead.toFixed(1) + 's)', 'warning', true); if (triggerEventDrivenRecovery('waiting')) return; setTimeout(function() { if (Engine.intent.shouldBePlaying && (audio.paused || audio.readyState < 3)) startRecovery(); }, 6000); });
  
  audio.addEventListener('error', function() { var err = audio.error; if (Engine.position.current > 0) savePositionToStorage(); isPlaying = false; updatePlayIcon(false); if (!Engine.intent.shouldBePlaying) return; if (err && (err.code === 2 || err.code === 4) && triggerEventDrivenRecovery('error')) return; if (err && err.code === 4 && !Engine.recovery.isActive && navigator.onLine) { showStatus('Puntata non disponibile', 'error'); Engine.intent.shouldBePlaying = false; } else startRecovery(); });
  
  audio.addEventListener('progress', updateBufferHealth);
  
  audio.addEventListener('timeupdate', function() {
    if (progressDragging) return;
    if (!audio.paused && audio.currentTime > 0) Engine.position.current = audio.currentTime;
    updateBufferHealth();
    var pct = (audio.currentTime / audio.duration) * 100 || 0;
    progressFill.style.width = pct + '%';
    currentTimeEl.textContent = formatTime(audio.currentTime);
    remainingTime.textContent = '-' + formatTime(audio.duration - audio.currentTime);
    if ('mediaSession' in navigator && audio.duration) navigator.mediaSession.setPositionState({ duration: audio.duration, playbackRate: audio.playbackRate, position: audio.currentTime });
  });
  audio.addEventListener('playing', function() { isPlaying = true; updatePlayIcon(true); hideStatus(); Engine.recovery.attempt = 0; Engine.recovery.isActive = false; });
}

// ============================================
// PLAY BUTTON
// ============================================
playBtn.addEventListener('click', function() {
  if (isPlaying) {
    Engine.intent.shouldBePlaying = false; Engine.intent.pausedByUser = true; Engine.recovery.isActive = false; Engine.position.current = audio.currentTime;
    clearRecoveryTimers(); audio.pause(); hideStatus(); savePositionToStorage();
  } else {
    Engine.intent.shouldBePlaying = true; Engine.intent.pausedByUser = false; Engine.intent.pausedBySystem = false; Engine.recovery.isActive = false; Engine.recovery.attempt = 0;
    clearRecoveryTimers(); var targetTime = Engine.position.current; showStatus('Avvio...', 'warning', true);
    if (!audio.src || audio.error || audio.readyState === 0) {
      var url = buildUrl(datePicker.value); Engine.currentUrl = url; audio.src = url;
      function onReady() { audio.removeEventListener('canplay', onReady); audio.removeEventListener('error', onLoadErr); if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) audio.currentTime = targetTime; audio.play().catch(function() { showStatus('Errore. Riprova.', 'error'); Engine.intent.shouldBePlaying = false; }); }
      function onLoadErr() { audio.removeEventListener('canplay', onReady); audio.removeEventListener('error', onLoadErr); showStatus('Errore caricamento', 'error'); Engine.intent.shouldBePlaying = false; }
      audio.addEventListener('canplay', onReady); audio.addEventListener('error', onLoadErr); audio.load();
    } else {
      if (targetTime > 0 && audio.duration && targetTime < audio.duration - 1) audio.currentTime = targetTime;
      audio.play().catch(function(e) {
        if (e.name === 'NotAllowedError') { showStatus('Tocca di nuovo Play', 'warning'); Engine.intent.shouldBePlaying = false; }
        else { var url = buildUrl(datePicker.value); Engine.currentUrl = url; audio.src = url + '?_t=' + Date.now(); audio.addEventListener('canplay', function onR() { audio.removeEventListener('canplay', onR); if (targetTime > 0 && audio.duration) audio.currentTime = targetTime; audio.play(); }); audio.load(); }
      });
    }
  }
});

// ============================================
// DATE PICKER & NAVIGATION
// ============================================
var today = new Date(); datePicker.value = today.toISOString().split('T')[0]; datePicker.max = datePicker.value;
datePickerBtn.addEventListener('click', function() { datePicker.showPicker(); });
datePicker.addEventListener('change', function() { updatePlayer(); updateNav(); updateFav(); updateMediaSession(); });

function updatePlayer() {
  var d = datePicker.value, url = buildUrl(d);
  clearRecoveryTimers(); Engine.currentUrl = url; Engine.position.current = loadPositionFromStorage(); Engine.position.lastSaved = Engine.position.current;
  Engine.recovery.attempt = 0; Engine.recovery.isActive = false; Engine.intent.shouldBePlaying = false;
  audio.src = url; episodeDate.textContent = formatDate(d); dateDisplay.textContent = formatDate(d);
  isPlaying = false; updatePlayIcon(false); progressFill.style.width = '0%'; bufferBar.style.width = '0%';
  currentTimeEl.textContent = formatTime(Engine.position.current); remainingTime.textContent = '-0:00'; hideStatus();
}

function updateNav() { var curr = new Date(datePicker.value), tod = new Date(); curr.setHours(0,0,0,0); tod.setHours(0,0,0,0); nextDay.disabled = curr >= tod; }
function changeDay(delta) { var d = new Date(datePicker.value); d.setDate(d.getDate() + delta); var str = d.toISOString().split('T')[0]; if (str <= datePicker.max) { datePicker.value = str; updatePlayer(); updateNav(); updateFav(); updateMediaSession(); } }
prevDay.addEventListener('click', function() { changeDay(-1); });
nextDay.addEventListener('click', function() { changeDay(1); });

// ============================================
// SKIP & PROGRESS
// ============================================
skipBack.addEventListener('click', function() { var t = Math.max(0, audio.currentTime - 30); Engine.position.current = t; audio.currentTime = t; });
skipForward.addEventListener('click', function() { var t = audio.currentTime + 30; Engine.position.current = t; audio.currentTime = t; });

function getProgressPct(e) { var r = progressBar.getBoundingClientRect(), x = e.touches ? e.touches[0].clientX : e.clientX; return Math.max(0, Math.min(1, (x - r.left) / r.width)); }
function updateProgressUI(pct) { progressFill.style.width = (pct * 100) + '%'; if (audio.duration) { seekTime = pct * audio.duration; currentTimeEl.textContent = formatTime(seekTime); remainingTime.textContent = '-' + formatTime(audio.duration - seekTime); } }
progressBar.addEventListener('mousedown', function(e) { progressDragging = true; updateProgressUI(getProgressPct(e)); });
progressBar.addEventListener('touchstart', function(e) { e.preventDefault(); progressDragging = true; updateProgressUI(getProgressPct(e)); }, {passive: false});
document.addEventListener('mousemove', function(e) { if (progressDragging) updateProgressUI(getProgressPct(e)); });
document.addEventListener('touchmove', function(e) { if (progressDragging) updateProgressUI(getProgressPct(e)); }, {passive: true});
document.addEventListener('mouseup', function() { if (progressDragging && audio.duration) { Engine.position.current = seekTime; audio.currentTime = seekTime; } progressDragging = false; });
document.addEventListener('touchend', function() { if (progressDragging && audio.duration) { Engine.position.current = seekTime; audio.currentTime = seekTime; } progressDragging = false; });

// ============================================
// THEME
// ============================================
var savedTheme = localStorage.getItem('bside-theme') || 'light';
applyTheme(savedTheme);

function applyTheme(t) {
  if (t === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/>';
    themeColorMeta.content = '#0a0a12';
  } else {
    document.documentElement.removeAttribute('data-theme');
    themeIcon.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>';
    themeColorMeta.content = '#f0f2f5';
  }
}

themeBtn.addEventListener('click', function() { var isDark = document.documentElement.getAttribute('data-theme') === 'dark'; var newTheme = isDark ? 'light' : 'dark'; applyTheme(newTheme); localStorage.setItem('bside-theme', newTheme); });

// ============================================
// VOLUME
// ============================================
volumeNavBtn.addEventListener('click', function() { volumeOverlay.classList.add('show'); });
volumeOverlay.addEventListener('click', function(e) { if (e.target === volumeOverlay) volumeOverlay.classList.remove('show'); });

function updateVol(e) { var r = volumeSlider.getBoundingClientRect(), y = (e.touches ? e.touches[0].clientY : e.clientY) - r.top, pct = 1 - (y / r.height); audio.volume = Math.max(0, Math.min(1, pct)); volumeFill.style.height = (audio.volume * 100) + '%'; updateVolIcon(); }
function updateVolIcon() { var v = audio.volume; if (v === 0) volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/>'; else if (v < 0.5) volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/>'; else volumeIcon.innerHTML = '<path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/>'; }
volumeSlider.addEventListener('mousedown', function(e) { volDrag = true; updateVol(e); });
volumeSlider.addEventListener('touchstart', function(e) { e.preventDefault(); volDrag = true; updateVol(e); });
document.addEventListener('mousemove', function(e) { if (volDrag) updateVol(e); });
document.addEventListener('touchmove', function(e) { if (volDrag) { e.preventDefault(); updateVol(e); } }, {passive: false});
document.addEventListener('mouseup', function() { volDrag = false; });
document.addEventListener('touchend', function() { volDrag = false; });

// ============================================
// SLEEP TIMER
// ============================================
sleepBtn.addEventListener('click', function() { sleepOverlay.classList.add('show'); });
sleepOverlay.addEventListener('click', function(e) { if (e.target === sleepOverlay) sleepOverlay.classList.remove('show'); });

var sleepOptions = document.querySelectorAll('.sleep-option');
sleepOptions.forEach(function(opt) { opt.addEventListener('click', function() { var min = parseInt(opt.getAttribute('data-min')); setSleep(min); sleepOverlay.classList.remove('show'); sleepOptions.forEach(function(o) { o.classList.remove('selected'); }); if (min > 0) opt.classList.add('selected'); }); });

function setSleep(min) {
  if (sleepTimer) clearTimeout(sleepTimer); if (sleepInterval) clearInterval(sleepInterval);
  if (min === 0) { sleepEndTime = null; sleepIcon.style.display = ''; sleepCountdown.style.display = 'none'; sleepBtn.classList.remove('active'); return; }
  sleepEndTime = Date.now() + min * 60000; sleepBtn.classList.add('active'); sleepIcon.style.display = 'none'; sleepCountdown.style.display = ''; updateSleepDisplay();
  sleepInterval = setInterval(updateSleepDisplay, 1000);
  sleepTimer = setTimeout(function() { Engine.intent.shouldBePlaying = false; audio.pause(); updatePlayIcon(false); isPlaying = false; setSleep(0); }, min * 60000);
}

function updateSleepDisplay() { if (!sleepEndTime) return; var rem = Math.max(0, sleepEndTime - Date.now()); if (rem === 0) { setSleep(0); return; } var m = Math.floor(rem / 60000), s = Math.floor((rem % 60000) / 1000); sleepCountdown.textContent = m + ':' + (s < 10 ? '0' : '') + s; }

// ============================================
// FAVORITES
// ============================================
favBtn.addEventListener('click', function() { var d = datePicker.value, idx = favorites.indexOf(d); if (idx > -1) favorites.splice(idx, 1); else favorites.unshift(d); localStorage.setItem('bside-fav', JSON.stringify(favorites)); updateFav(); });
function updateFav() { favBtn.classList.toggle('active', favorites.indexOf(datePicker.value) > -1); }
menuBtn.addEventListener('click', function() { renderFavList(); favOverlay.classList.add('show'); });
favOverlay.addEventListener('click', function(e) { if (e.target === favOverlay) favOverlay.classList.remove('show'); });

function renderFavList() {
  if (favorites.length === 0) { favList.innerHTML = '<div class="favorites-empty">Nessun preferito</div>'; return; }
  var h = ''; for (var i = 0; i < favorites.length; i++) { var d = favorites[i]; h += '<div class="fav-item" data-date="' + d + '"><span>' + formatDate(d) + '</span><button class="fav-item-del" data-date="' + d + '"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>'; }
  favList.innerHTML = h;
  favList.querySelectorAll('.fav-item').forEach(function(item) { item.addEventListener('click', function(e) { if (!e.target.closest('.fav-item-del')) { datePicker.value = item.getAttribute('data-date'); updatePlayer(); updateNav(); updateFav(); updateMediaSession(); favOverlay.classList.remove('show'); } }); });
  favList.querySelectorAll('.fav-item-del').forEach(function(btn) { btn.addEventListener('click', function(e) { e.stopPropagation(); var d = btn.getAttribute('data-date'), idx = favorites.indexOf(d); if (idx > -1) favorites.splice(idx, 1); localStorage.setItem('bside-fav', JSON.stringify(favorites)); updateFav(); renderFavList(); }); });
}

// ============================================
// MEDIA SESSION
// ============================================
function updateMediaSession() { if ('mediaSession' in navigator) navigator.mediaSession.metadata = new MediaMetadata({ title: 'Puntata del ' + formatDate(datePicker.value), artist: 'Alessio Bertallot', album: 'B-SIDE - Radio Capital', artwork: [{src: 'icon-192.png', sizes: '192x192', type: 'image/png'}, {src: 'icon-512.png', sizes: '512x512', type: 'image/png'}] }); }
if ('mediaSession' in navigator) {
  navigator.mediaSession.setActionHandler('play', function() { Engine.intent.shouldBePlaying = true; if (Engine.position.current > 0 && audio.duration && Engine.position.current < audio.duration) audio.currentTime = Engine.position.current; audio.play(); });
  navigator.mediaSession.setActionHandler('pause', function() { Engine.position.current = audio.currentTime; Engine.intent.shouldBePlaying = false; Engine.intent.pausedByUser = true; audio.pause(); });
  navigator.mediaSession.setActionHandler('seekbackward', function() { var t = Math.max(0, audio.currentTime - 30); Engine.position.current = t; audio.currentTime = t; });
  navigator.mediaSession.setActionHandler('seekforward', function() { var t = audio.currentTime + 30; Engine.position.current = t; audio.currentTime = t; });
  navigator.mediaSession.setActionHandler('seekto', function(d) { if (d.seekTime) { Engine.position.current = d.seekTime; audio.currentTime = d.seekTime; } });
}

// ============================================
// PWA INSTALL
// ============================================
window.addEventListener('beforeinstallprompt', function(e) { e.preventDefault(); deferredPrompt = e; document.getElementById('installPrompt').classList.add('show'); });
document.getElementById('installBtn').addEventListener('click', function() { if (deferredPrompt) { deferredPrompt.prompt(); deferredPrompt.userChoice.then(function() { deferredPrompt = null; document.getElementById('installPrompt').classList.remove('show'); }); } });
document.getElementById('installClose').addEventListener('click', function() { document.getElementById('installPrompt').classList.remove('show'); });
window.addEventListener('appinstalled', function() { document.getElementById('installPrompt').classList.remove('show'); });

// ============================================
// SERVICE WORKER
// ============================================
if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').then(function(){}).catch(function(){});

// ============================================
// INITIALIZATION
// ============================================
function init() {
  initNetworkMonitoring(); initPositionTracking(); initLifecycleManagement(); initAudioEvents();
  updatePlayer(); updateNav(); updateFav(); updateVolIcon(); updateMediaSession();
  var maxAge = 30 * 24 * 60 * 60 * 1000, now = Date.now(), keysToRemove = [];
  for (var i = 0; i < localStorage.length; i++) { var key = localStorage.key(i); if (key && key.startsWith('bside-pos-')) { try { var data = JSON.parse(localStorage.getItem(key)); if (now - data.timestamp > maxAge) keysToRemove.push(key); } catch(e) { keysToRemove.push(key); } } }
  keysToRemove.forEach(function(k) { localStorage.removeItem(k); });
}

init();
</script>
</body>
</html>
