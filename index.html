<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#ffffff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="B-SIDE">
  <title>B-SIDE</title>
  
  <link rel="manifest" href="data:application/json,{
    %22name%22:%22B-SIDE%20-%20Alessio%20Bertallot%22,
    %22short_name%22:%22B-SIDE%22,
    %22description%22:%22Player%20podcast%20B-SIDE%20di%20Alessio%20Bertallot%22,
    %22start_url%22:%22.%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23ffffff%22,
    %22theme_color%22:%22%23ffffff%22,
    %22icons%22:[{
      %22src%22:%22data:image/svg+xml,%253Csvg%2520xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%2520viewBox%3D%270%25200%2520192%2520192%27%253E%253Crect%2520fill%3D%27%2523333%27%2520width%3D%27192%27%2520height%3D%27192%27%2520rx%3D%252732%27%2F%253E%253Ctext%2520x%3D%272796%27%2520y%3D%27140%27%2520font-size%3D%2780%27%2520fill%3D%27white%27%2520font-family%3D%27Arial%27%2520font-weight%3D%27bold%27%253EB%253C%2Ftext%253E%253C%2Fsvg%253E%22,
      %22sizes%22:%22192x192%22,
      %22type%22:%22image/svg+xml%22
    }]
  }">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #fafafa;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .container {
      background: #fff;
      border-radius: 12px;
      padding: 32px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      width: 100%;
      max-width: 400px;
    }
    
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 4px;
      text-align: center;
    }
    
    .subtitle {
      font-size: 0.9rem;
      color: #666;
      text-align: center;
      margin-bottom: 4px;
    }
    
    .episode {
      font-size: 0.8rem;
      color: #999;
      text-align: center;
      margin-bottom: 24px;
    }
    
    .controls {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 16px;
    }
    
    .skip-btn {
      background: #fff;
      border: 1px solid #e0e0e0;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      color: #333;
      transition: all 0.2s;
    }
    
    .skip-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
    }
    
    .play-btn {
      background: transparent;
      border: 1px solid #e0e0e0;
      border-radius: 50%;
      width: 64px;
      height: 64px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      color: #333;
      transition: all 0.2s;
    }
    
    .play-btn:hover {
      background: #f0f0f0;
      border-color: #ccc;
      transform: scale(1.05);
    }
    
    .date-section {
      margin-bottom: 24px;
    }
    
    label {
      display: block;
      font-size: 0.875rem;
      color: #666;
      margin-bottom: 8px;
    }
    
    input[type="date"] {
      width: 100%;
      padding: 12px 16px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1rem;
      color: #1a1a1a;
      background: #fff;
      cursor: pointer;
      transition: border-color 0.2s;
    }
    
    input[type="date"]:hover {
      border-color: #999;
    }
    
    input[type="date"]:focus {
      outline: none;
      border-color: #333;
    }
    
    .player-section {
      background: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
    }
    
    .progress-container {
      width: 100%;
      margin-bottom: 8px;
    }
    
    #progressSlider {
      width: 100%;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: linear-gradient(to right, #1a1a1a 0%, #ddd 0%);
      border-radius: 2px;
      cursor: pointer;
    }
    
    #progressSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
    }
    
    #progressSlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    
    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      color: #666;
      margin-bottom: 12px;
    }
    
    .volume-control {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .volume-icon {
      font-size: 1.1rem;
      cursor: pointer;
      user-select: none;
      line-height: 1;
    }
    
    #volumeSlider {
      flex: 1;
      height: 4px;
      -webkit-appearance: none;
      appearance: none;
      background: #ddd;
      border-radius: 2px;
      cursor: pointer;
    }
    
    #volumeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 12px;
      height: 12px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
    }
    
    #volumeSlider::-moz-range-thumb {
      width: 12px;
      height: 12px;
      background: #1a1a1a;
      border-radius: 50%;
      cursor: pointer;
      border: none;
    }
    
    audio {
      display: none;
    }
    
    .install-prompt {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      background: #333;
      color: #fff;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      z-index: 1000;
    }
    
    .install-prompt.show {
      display: block;
    }
    
    .install-prompt p {
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    
    .install-btn {
      background: #fff;
      color: #333;
      border: none;
      padding: 10px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
      margin-right: 8px;
    }
    
    .install-close {
      background: transparent;
      color: #999;
      border: 1px solid #666;
      padding: 10px 16px;
      border-radius: 8px;
      font-size: 0.9rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>B-SIDE</h1>
    <p class="subtitle">Alessio Bertallot</p>
    <p class="episode" id="episodeDate">Puntata del â€”</p>
    
    <div class="date-section">
      <label for="datePicker">Seleziona data</label>
      <input type="date" id="datePicker">
    </div>
    
    <div class="player-section">
      <div class="controls">
        <button class="skip-btn" id="skipBack">-30s</button>
        <button class="play-btn" id="playBtn">â–¶</button>
        <button class="skip-btn" id="skipForward">+30s</button>
      </div>
      <audio id="audioPlayer">
        Il tuo browser non supporta l'elemento audio.
      </audio>
      <div class="progress-container">
        <input type="range" id="progressSlider" min="0" max="100" step="0.1" value="0">
      </div>
      <div class="time-display">
        <span id="currentTime">0:00</span>
        <span id="duration">0:00</span>
      </div>
      <div class="volume-control">
        <input type="range" id="volumeSlider" min="0" max="1" step="0.01" value="1">
        <span class="volume-icon" id="volumeIcon">ðŸ”Š</span>
      </div>
    </div>
  </div>
  
  <div class="install-prompt" id="installPrompt">
    <p>Installa B-SIDE sulla tua home screen</p>
    <button class="install-btn" id="installBtn">Installa</button>
    <button class="install-close" id="installClose">No grazie</button>
  </div>

  <script>
    const datePicker = document.getElementById('datePicker');
    const audioPlayer = document.getElementById('audioPlayer');
    const episodeDate = document.getElementById('episodeDate');
    const skipBack = document.getElementById('skipBack');
    const skipForward = document.getElementById('skipForward');
    const playBtn = document.getElementById('playBtn');
    const progressSlider = document.getElementById('progressSlider');
    const currentTimeEl = document.getElementById('currentTime');
    const durationEl = document.getElementById('duration');
    const volumeSlider = document.getElementById('volumeSlider');
    const volumeIcon = document.getElementById('volumeIcon');
    
    let isPlaying = false;
    let lastVolume = 1;
    let isDragging = false;
    
    const today = new Date();
    datePicker.value = today.toISOString().split('T')[0];
    datePicker.max = today.toISOString().split('T')[0];
    
    function buildUrl(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `https://media.capital.it/${year}/${month}/${day}/episodes/bertallot/bertallot_${year}${month}${day}_220000.mp3`;
    }
    
    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      return `${day}/${month}/${year}`;
    }
    
    function formatTime(sec) {
      if (isNaN(sec)) return '0:00';
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${s.toString().padStart(2, '0')}`;
    }
    
    function updatePlayer() {
      const dateValue = datePicker.value;
      if (dateValue) {
        audioPlayer.src = buildUrl(dateValue);
        episodeDate.textContent = `Puntata del ${formatDate(dateValue)}`;
        isPlaying = false;
        playBtn.textContent = 'â–¶';
        progressSlider.value = 0;
        updateProgressBackground(0);
        currentTimeEl.textContent = '0:00';
        durationEl.textContent = '0:00';
      }
    }
    
    function updateProgressBackground(pct) {
      progressSlider.style.background = `linear-gradient(to right, #1a1a1a ${pct}%, #ddd ${pct}%)`;
    }
    
    playBtn.addEventListener('click', () => {
      if (isPlaying) {
        audioPlayer.pause();
        playBtn.textContent = 'â–¶';
      } else {
        audioPlayer.play();
        playBtn.textContent = 'âšâš';
      }
      isPlaying = !isPlaying;
    });
    
    audioPlayer.addEventListener('timeupdate', () => {
      if (!isDragging) {
        const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
        progressSlider.value = pct;
        updateProgressBackground(pct);
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      }
    });
    
    audioPlayer.addEventListener('loadedmetadata', () => {
      durationEl.textContent = formatTime(audioPlayer.duration);
      progressSlider.max = 100;
      
      if ('mediaSession' in navigator) {
        navigator.mediaSession.setPositionState({
          duration: audioPlayer.duration,
          playbackRate: 1,
          position: 0
        });
      }
    });
    
    progressSlider.addEventListener('input', () => {
      isDragging = true;
      const pct = progressSlider.value;
      updateProgressBackground(pct);
      const time = (pct / 100) * audioPlayer.duration;
      currentTimeEl.textContent = formatTime(time);
    });
    
    progressSlider.addEventListener('change', () => {
      const pct = progressSlider.value;
      audioPlayer.currentTime = (pct / 100) * audioPlayer.duration;
      isDragging = false;
    });
    
    datePicker.addEventListener('change', () => {
      updatePlayer();
      updateMediaSessionMetadata();
    });
    skipBack.addEventListener('click', () => audioPlayer.currentTime -= 30);
    skipForward.addEventListener('click', () => audioPlayer.currentTime += 30);
    
    volumeSlider.addEventListener('input', () => {
      audioPlayer.volume = volumeSlider.value;
      updateVolumeIcon();
    });
    
    volumeIcon.addEventListener('click', () => {
      if (audioPlayer.volume > 0) {
        lastVolume = audioPlayer.volume;
        audioPlayer.volume = 0;
        volumeSlider.value = 0;
      } else {
        audioPlayer.volume = lastVolume;
        volumeSlider.value = lastVolume;
      }
      updateVolumeIcon();
    });
    
    function updateVolumeIcon() {
      const v = audioPlayer.volume;
      if (v === 0) volumeIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><line x1="23" y1="9" x2="17" y2="15"/><line x1="17" y1="9" x2="23" y2="15"/></svg>';
      else if (v < 0.5) volumeIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/></svg>';
      else volumeIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"/><path d="M15.54 8.46a5 5 0 010 7.07"/><path d="M19.07 4.93a10 10 0 010 14.14"/></svg>';
    }
    
    // PWA Install
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installBtn = document.getElementById('installBtn');
    const installClose = document.getElementById('installClose');
    
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('show');
    });
    
    installBtn.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        deferredPrompt = null;
        installPrompt.classList.remove('show');
      }
    });
    
    installClose.addEventListener('click', () => {
      installPrompt.classList.remove('show');
    });
    
    window.addEventListener('appinstalled', () => {
      installPrompt.classList.remove('show');
    });
    
    // Media Session API per background playback
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({
        title: 'B-SIDE',
        artist: 'Alessio Bertallot',
        album: 'Radio Capital',
        artwork: [
          { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect fill="%23333" width="512" height="512" rx="64"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="200" fill="white" font-family="Arial" font-weight="bold">B</text></svg>', sizes: '512x512', type: 'image/svg+xml' }
        ]
      });
      
      navigator.mediaSession.setActionHandler('play', () => {
        audioPlayer.play();
        playBtn.textContent = 'âšâš';
        isPlaying = true;
      });
      
      navigator.mediaSession.setActionHandler('pause', () => {
        audioPlayer.pause();
        playBtn.textContent = 'â–¶';
        isPlaying = false;
      });
      
      navigator.mediaSession.setActionHandler('seekbackward', () => {
        audioPlayer.currentTime -= 30;
      });
      
      navigator.mediaSession.setActionHandler('seekforward', () => {
        audioPlayer.currentTime += 30;
      });
      
      navigator.mediaSession.setActionHandler('seekto', (details) => {
        if (details.seekTime) {
          audioPlayer.currentTime = details.seekTime;
        }
      });
    }
    
    // Aggiorna metadata quando cambia la data
    function updateMediaSessionMetadata() {
      if ('mediaSession' in navigator) {
        const dateValue = datePicker.value;
        navigator.mediaSession.metadata = new MediaMetadata({
          title: `Puntata del ${formatDate(dateValue)}`,
          artist: 'Alessio Bertallot',
          album: 'B-SIDE - Radio Capital',
          artwork: [
            { src: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect fill="%23333" width="512" height="512" rx="64"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" font-size="200" fill="white" font-family="Arial" font-weight="bold">B</text></svg>', sizes: '512x512', type: 'image/svg+xml' }
          ]
        });
      }
    }
    
    // Aggiorna posizione per la barra di avanzamento nel lockscreen
    audioPlayer.addEventListener('timeupdate', () => {
      if (!isDragging) {
        const pct = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
        progressSlider.value = pct;
        updateProgressBackground(pct);
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        
        if ('mediaSession' in navigator && audioPlayer.duration) {
          navigator.mediaSession.setPositionState({
            duration: audioPlayer.duration,
            playbackRate: audioPlayer.playbackRate,
            position: audioPlayer.currentTime
          });
        }
      }
    });
    
    updateVolumeIcon();
    updatePlayer();
    updateMediaSessionMetadata();
  </script>
</body>
</html>
